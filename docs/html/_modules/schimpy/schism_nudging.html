
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>schimpy.schism_nudging &#8212; schimpy 1.3.6+7.g9f86f0f.dirty documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinxdoc.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../index.html"><img src="../../_static/logo6.png" border="0" alt="Bay-Delta SELFE Tools"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">home</a>|&nbsp;</li>
        <li><a href="../../search.html">search</a>|&nbsp;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">schimpy.schism_nudging</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for schimpy.schism_nudging</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Tue Jun  8 10:19:56 2021</span>

<span class="sd">@author: zzhang</span>
<span class="sd">To be implemented: other weights function (length scale) from OI in additional </span>
<span class="sd">to gaussian</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">netCDF4</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">schimpy.schism_mesh</span> <span class="kn">import</span> <span class="n">read_mesh</span><span class="p">,</span> <span class="n">write_mesh</span>
<span class="kn">from</span> <span class="nn">schimpy.geo_tools</span> <span class="kn">import</span> <span class="n">utm2ll</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">schimpy</span>  <span class="kn">import</span> <span class="n">Interp2D</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">timer</span>
<span class="kn">from</span> <span class="nn">vtools.data.vtime</span> <span class="kn">import</span> <span class="n">hours</span><span class="p">,</span><span class="n">days</span>

<div class="viewcode-block" id="nudging"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging">[docs]</a><span class="k">class</span> <span class="nc">nudging</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to create schism nudging</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yaml_fn</span><span class="p">,</span><span class="n">crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yaml_fn</span> <span class="o">=</span> <span class="n">yaml_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interpolant</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span><span class="s1">&#39;inverse distance&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gaussian&#39;</span><span class="p">]</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">crs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_suffix</span> <span class="o">=</span> <span class="n">suffix</span>
           
<div class="viewcode-block" id="nudging.read_yaml"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging.read_yaml">[docs]</a>    <span class="k">def</span> <span class="nf">read_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        read yaml and load mesh grid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yaml_fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
        <span class="n">nudging_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;nudging&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">nudging_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">nudging_info</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnday</span> <span class="o">=</span> <span class="n">nudging_info</span><span class="p">[</span><span class="s1">&#39;rnday&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rnday</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nudge_step</span> <span class="o">=</span> <span class="n">nudging_info</span><span class="p">[</span><span class="s1">&#39;step_nu_tr&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">,</span>
                                      <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nudge_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">-</span> \
            <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_seconds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hgrid_fn</span> <span class="o">=</span> <span class="n">nudging_info</span><span class="p">[</span><span class="s1">&#39;hgrid_input_file&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vgrid_fn</span> <span class="o">=</span> <span class="n">nudging_info</span><span class="p">[</span><span class="s1">&#39;vgrid_input_file&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">nudging_info</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vgrid_version</span> <span class="o">=</span> <span class="n">nudging_info</span><span class="p">[</span><span class="s1">&#39;vgrid_version&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">read_mesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hgrid_fn</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">vgrid_fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vgrid_version</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">nnode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_nodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nvrt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_vert_levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mesh_gpd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;crs&#39;</span> <span class="ow">in</span> <span class="n">nudging_info</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">nudging_info</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="s1">&#39;EPSG:26910&#39;</span> <span class="c1"># this is required because ROMS only provides lat, lon. </span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;crs not specified, and assigned to the default crs for UTM10N&quot;</span><span class="p">)</span>
                    
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_suffix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;output_suffix&#39;</span> <span class="ow">in</span> <span class="n">nudging_info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_suffix</span> <span class="o">=</span> <span class="n">nudging_info</span><span class="p">[</span><span class="s1">&#39;output_suffix&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_suffix</span> <span class="o">=</span> <span class="kc">None</span></div>
        
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mesh_gpd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mesh_gpd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mesh_gpd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">to_geopandas</span><span class="p">(</span><span class="s1">&#39;point&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mesh_gpd</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">build_z</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span>

<div class="viewcode-block" id="nudging.create_nudging"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging.create_nudging">[docs]</a>    <span class="k">def</span> <span class="nf">create_nudging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">create_file</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        suffix : TYPE, optional</span>
<span class="sd">            Options to give a suffix to the output nuding files. </span>
<span class="sd">            The default is &#39;nu.nc&#39;</span>
<span class="sd">        create_file : TYPE, optional</span>
<span class="sd">            Options to create nudging files. The default is True.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">weights_comb</span><span class="p">,</span> <span class="n">values_comb</span><span class="p">,</span> <span class="n">imap_comb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nudging_comb</span><span class="p">()</span>
        
        <span class="n">weights_var</span><span class="p">,</span> <span class="n">values_var</span><span class="p">,</span> <span class="n">imap_var</span><span class="p">,</span> <span class="n">var_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">organize_nudging</span><span class="p">(</span>
            <span class="n">weights_comb</span><span class="p">,</span> <span class="n">values_comb</span><span class="p">,</span> <span class="n">imap_comb</span><span class="p">)</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">concatenate_nudge</span><span class="p">(</span><span class="n">weights_var</span><span class="p">,</span> 
                <span class="n">values_var</span><span class="p">,</span>
                <span class="n">imap_var</span><span class="p">,</span>
                <span class="n">var_v</span><span class="p">,</span>
                <span class="n">create_file</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    </div>
    
<div class="viewcode-block" id="nudging.organize_nudging"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging.organize_nudging">[docs]</a>    <span class="k">def</span> <span class="nf">organize_nudging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights_comb</span><span class="p">,</span> <span class="n">values_comb</span><span class="p">,</span> <span class="n">imap_comb</span><span class="p">):</span>   
        <span class="n">weights_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#dimension [region, var, node]</span>
        <span class="n">values_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># dimensino [region, var, time, map_node, nlevel]</span>
        <span class="n">imap_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># dimension [region, var, map_node] </span>
        <span class="c1"># get a list of variables</span>
        <span class="n">var_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;polygons&#39;</span><span class="p">]:</span>
            <span class="n">var_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_list</span><span class="p">,</span> 
                                 <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;interpolant&#39;</span><span class="p">][</span><span class="s1">&#39;variables&#39;</span><span class="p">]])</span>
        <span class="n">var_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">var_list</span><span class="p">)</span>
                
        <span class="c1"># eliminate variables that don&#39;t exist in records</span>
        <span class="n">weights_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#dimension [region, var, node]</span>
        <span class="n">values_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># dimensino [region, var, time, map_node, nlevel]</span>
        <span class="n">imap_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># dimension [region, var, map_node]</span>
        <span class="k">for</span> <span class="n">pi</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;polygons&#39;</span><span class="p">]):</span>            
            <span class="n">weights_v</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">values_v</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">imap_v</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">var_v</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">var_info</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;interpolant&#39;</span><span class="p">][</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span>
            <span class="n">var_name</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_info</span><span class="p">])</span>
             
            <span class="k">for</span> <span class="n">vi</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">var_list</span><span class="p">):</span>
                <span class="c1"># reorder according to [&#39;temperature&#39;,&#39;salinity&#39;]</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_name</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">var_name</span><span class="o">==</span><span class="n">v</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imap_comb</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">pos</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">weights_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights_comb</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">pos</span><span class="p">])</span>
                        <span class="n">values_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values_comb</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">pos</span><span class="p">])</span>
                        <span class="n">imap_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imap_comb</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">pos</span><span class="p">])</span>  
                        <span class="n">var_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">weights_v</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">values_v</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">imap_v</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">var_v</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">weights_v</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="n">values_v</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="n">imap_v</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="n">var_v</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>                    
            <span class="c1">#if np.any(weights_v):</span>
            <span class="n">weights_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights_v</span><span class="p">)</span>
            <span class="n">values_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values_v</span><span class="p">)</span>
            <span class="n">imap_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imap_v</span><span class="p">)</span>        
        
        <span class="n">values_var</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">#rearrange to dim [var, region, time, map_node, nlevel]</span>
        <span class="n">imap_var</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># rearrange to dim [var, region, map_node]</span>
        <span class="n">weights_var</span> <span class="o">=</span> <span class="p">[]</span>        
        
        <span class="c1">#weights_var = np.array(weights_list).transpose([1,0,2])#rearrange to dim [var, region,node]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">var_list</span><span class="p">):</span>
                <span class="n">values_var</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">vl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">vl</span> <span class="ow">in</span> <span class="n">values_list</span><span class="p">])</span>
                <span class="n">imap_var</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">imap_list</span><span class="p">])</span>
                <span class="n">weights_var</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">wv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">wv</span> <span class="ow">in</span> <span class="n">weights_list</span><span class="p">])</span>
        <span class="n">var_v</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vi</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">var_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">weights_var</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="n">vi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">var_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="n">weights_var</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights_var</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vi</span><span class="p">]</span>
        <span class="n">values_var</span> <span class="o">=</span> <span class="p">[</span><span class="n">values_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vi</span><span class="p">]</span>
        <span class="n">imap_var</span> <span class="o">=</span> <span class="p">[</span><span class="n">imap_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vi</span><span class="p">]</span>                           
        <span class="k">return</span> <span class="n">weights_var</span><span class="p">,</span> <span class="n">values_var</span><span class="p">,</span> <span class="n">imap_var</span><span class="p">,</span> <span class="n">var_v</span></div>

<div class="viewcode-block" id="nudging.get_nudging_comb"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging.get_nudging_comb">[docs]</a>    <span class="k">def</span> <span class="nf">get_nudging_comb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">weights_comb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">values_comb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">imap_comb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;polygons&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;creating nudging for polygon </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="n">weights</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">imap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_region_nudging</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">weights_comb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
            <span class="n">values_comb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">imap_comb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imap</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">weights_comb</span><span class="p">,</span> <span class="n">values_comb</span><span class="p">,</span> <span class="n">imap_comb</span>    </div>
    
<div class="viewcode-block" id="nudging.concatenate_nudge"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging.concatenate_nudge">[docs]</a>    <span class="k">def</span> <span class="nf">concatenate_nudge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights_var</span><span class="p">,</span> <span class="n">values_var</span><span class="p">,</span> <span class="n">imap_var</span><span class="p">,</span>
                          <span class="n">var_newlist</span><span class="p">,</span> <span class="n">create_file</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">var_newlist</span><span class="p">):</span>
            <span class="c1"># merge all the mapping values</span>
            <span class="n">imap_merged</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">imap_var</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">imap_merged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imap_merged</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
            <span class="n">imap_merged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">imap_merged</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            
            <span class="c1"># finding the corresponding indices for each region (map from imap_var to imap_merged)</span>
            <span class="n">idx_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">imap_merged</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;polygons&#39;</span><span class="p">]))</span>
                                <span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imap_merged</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imap_var</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">l</span><span class="o">==</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">idx_list</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">idx_list</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            
            <span class="c1"># check to see if there is any overlap among the regions, if yes, </span>
            <span class="c1"># take the weighted average  </span>
            <span class="n">weights_merged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">weights_var</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">values_merged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">imap_merged</span><span class="p">),</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">nvrt</span><span class="p">))</span> 
            <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imap_merged</span><span class="p">)):</span>
                <span class="n">idx_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">idx_list</span><span class="p">[</span><span class="n">im</span><span class="p">,:]))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_r</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># overlapping regions</span>
                    <span class="n">values_sum</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">weights_sum</span> <span class="o">=</span> <span class="p">[]</span>  
                    <span class="n">weights_sum2</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">idx_r</span><span class="p">:</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">weights_var</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">r</span><span class="p">,</span><span class="n">imap_merged</span><span class="p">[</span><span class="n">im</span><span class="p">]]</span>
                        <span class="n">data_values</span> <span class="o">=</span> <span class="n">values_var</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">r</span><span class="p">][:,</span><span class="nb">int</span><span class="p">(</span><span class="n">idx_list</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="n">r</span><span class="p">]),:]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_values</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;warning: nan values are detected in the overlapping region. The nudging values are set to -9999.0 for these regions. &quot;</span><span class="p">)</span>
                        <span class="n">values_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">data_values</span><span class="p">)</span>
                        <span class="n">weights_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                        <span class="n">weights_sum2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">values_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">values_sum</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights_sum</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">values_temp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">):</span>
                        <span class="n">values_merged</span><span class="p">[:,</span><span class="n">im</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">values_temp</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">),:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">values_merged</span><span class="p">[:,</span><span class="n">im</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">values_temp</span>
                    <span class="c1">#values_merged[:,im,:] = np.sum(values_sum,axis=0)/sum(weights_sum)</span>
                    <span class="n">weights_merged</span><span class="p">[</span><span class="n">imap_merged</span><span class="p">[</span><span class="n">im</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights_sum2</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights_sum</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">idx_r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">weights_merged</span><span class="p">[</span><span class="n">imap_merged</span><span class="p">[</span><span class="n">im</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">weights_var</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">r</span><span class="p">,</span><span class="n">imap_merged</span><span class="p">[</span><span class="n">im</span><span class="p">]]</span>
                    <span class="n">values_merged</span><span class="p">[:,</span><span class="n">im</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">values_var</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">r</span><span class="p">][:,</span><span class="nb">int</span><span class="p">(</span><span class="n">idx_list</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="n">r</span><span class="p">]),:]</span>
            
            <span class="c1"># for the last time, make sure that all nan values are set to -9999.0</span>
            <span class="n">values_merged</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">values_merged</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.0</span>
                    
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_suffix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_suffix</span> 
            
            <span class="k">if</span> <span class="n">v</span><span class="o">==</span> <span class="s1">&#39;temperature&#39;</span><span class="p">:</span>
                <span class="n">nudging_fn</span> <span class="o">=</span> <span class="s2">&quot;TEM_nu_</span><span class="si">%s</span><span class="s2">.nc&quot;</span><span class="o">%</span><span class="n">suffix</span>     
            <span class="k">elif</span> <span class="n">v</span><span class="o">==</span><span class="s1">&#39;salinity&#39;</span><span class="p">:</span>
                <span class="n">nudging_fn</span> <span class="o">=</span> <span class="s2">&quot;SAL_nu_</span><span class="si">%s</span><span class="s2">.nc&quot;</span><span class="o">%</span><span class="n">suffix</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;write </span><span class="si">%s</span><span class="s2"> as nuding nc not implemented&quot;</span><span class="o">%</span><span class="n">v</span><span class="p">)</span>
                           
            <span class="n">rootgrp_T</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">nudging_fn</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;NETCDF4&quot;</span><span class="p">)</span>
            <span class="n">node_dim</span> <span class="o">=</span> <span class="n">rootgrp_T</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">imap_merged</span><span class="p">))</span>
            <span class="n">nv_dim</span> <span class="o">=</span> <span class="n">rootgrp_T</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s2">&quot;nLevels&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvrt</span><span class="p">)</span>
            <span class="n">one_dim</span> <span class="o">=</span> <span class="n">rootgrp_T</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">itime_dim</span> <span class="o">=</span> <span class="n">rootgrp_T</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_seconds</span><span class="p">))</span>
            
            <span class="n">itime_id_T</span> <span class="o">=</span> <span class="n">rootgrp_T</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;f&quot;</span><span class="p">,(</span><span class="s2">&quot;time&quot;</span><span class="p">,))</span>
            <span class="n">id_map_T</span> <span class="o">=</span> <span class="n">rootgrp_T</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;map_to_global_node&quot;</span><span class="p">,</span><span class="s2">&quot;i&quot;</span><span class="p">,</span>
                                                <span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">,))</span>
            <span class="n">ivar_T</span> <span class="o">=</span> <span class="n">rootgrp_T</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;tracer_concentration&quot;</span><span class="p">,</span><span class="s2">&quot;f&quot;</span><span class="p">,</span>
                                            <span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;node&quot;</span><span class="p">,</span><span class="s2">&quot;nLevels&quot;</span><span class="p">,</span><span class="s2">&quot;one&quot;</span><span class="p">,))</span>  
                
            <span class="n">id_map_T</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imap_merged</span><span class="p">)</span> <span class="o">+</span><span class="mi">1</span>  <span class="c1">#in schism indices are 1 based   </span>
            <span class="n">itime_id_T</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_seconds</span>            
            
           <span class="c1"># current var dimension [time, map_node, nlevel]</span>
            <span class="n">ivar_T</span><span class="p">[:,:,:,:]</span> <span class="o">=</span> <span class="n">values_merged</span><span class="p">[:,:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> 
            <span class="n">rootgrp_T</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> file created&quot;</span><span class="o">%</span><span class="n">nudging_fn</span><span class="p">)</span>  
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">write_mesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> 
                           <span class="n">fpath_mesh</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_nudge.gr3&quot;</span><span class="o">%</span><span class="n">v</span><span class="p">,</span> 
                           <span class="n">node_attr</span><span class="o">=</span><span class="n">weights_merged</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">write_mesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> 
                           <span class="n">fpath_mesh</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_nudge_</span><span class="si">%s</span><span class="s2">.gr3&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output_suffix</span><span class="p">),</span> 
                       <span class="n">node_attr</span><span class="o">=</span><span class="n">weights_merged</span><span class="p">)</span></div>
        <span class="c1">#return values_merged, weights_merged, imap_merged</span>
    
<div class="viewcode-block" id="nudging.create_region_nudging"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging.create_region_nudging">[docs]</a>    <span class="k">def</span> <span class="nf">create_region_nudging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_info</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">region_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;roms&#39;</span><span class="p">:</span>
            <span class="n">weights</span><span class="p">,</span> <span class="n">values_list</span><span class="p">,</span> <span class="n">imap</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_nudge_roms</span><span class="p">(</span><span class="n">region_info</span><span class="p">)</span>
            <span class="c1">#values_list =  [vl[:,imap,:] for vl in values_list]</span>
            <span class="n">nvar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> 
                                <span class="n">region_info</span><span class="p">[</span><span class="s1">&#39;interpolant&#39;</span><span class="p">][</span><span class="s1">&#39;variables&#39;</span><span class="p">]]))</span>
            <span class="n">weights_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">weights</span><span class="p">,[</span><span class="n">nvar</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)])</span>
            <span class="n">imap_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">imap</span><span class="p">,[</span><span class="n">nvar</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">imap</span><span class="p">)])</span>
        <span class="k">elif</span> <span class="s1">&#39;obs&#39;</span> <span class="ow">in</span> <span class="n">region_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]:</span>  <span class="c1"># this is 2D interpolation</span>
            <span class="n">weights_list</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">imap_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_nudge_obs</span><span class="p">(</span><span class="n">region_info</span><span class="p">)</span>
            <span class="n">values_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">v</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvrt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">v</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">v</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span> 
                           <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
            <span class="n">values_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">v</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> 
                           <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values_list</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span><span class="p">(</span><span class="s2">&quot;region type not implemented:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">region_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">weights_list</span><span class="p">,</span> <span class="n">values_list</span><span class="p">,</span> <span class="n">imap_list</span></div>
    
<div class="viewcode-block" id="nudging.gen_nudge_roms"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging.gen_nudge_roms">[docs]</a>    <span class="k">def</span> <span class="nf">gen_nudge_roms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">region_info</span><span class="p">):</span>
        <span class="n">rjunk</span> <span class="o">=</span> <span class="mi">9998</span> <span class="c1">#!Define junk value for sid; the test is abs()&gt;rjunk</span>
        <span class="n">hr_char</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;03&#39;</span><span class="p">,</span><span class="s1">&#39;09&#39;</span><span class="p">,</span><span class="s1">&#39;15&#39;</span><span class="p">,</span><span class="s1">&#39;21&#39;</span><span class="p">]</span> <span class="c1">#each day has 4 starting hours in ROMS</span>
        <span class="n">small1</span> <span class="o">=</span> <span class="mf">1.e-2</span> <span class="c1">#used to check area ratios</span>
        <span class="n">weights</span><span class="p">,</span> <span class="n">obs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_region_weight</span><span class="p">(</span><span class="n">region_info</span><span class="p">[</span><span class="s1">&#39;attribute&#39;</span><span class="p">],</span>
                                                 <span class="n">region_info</span><span class="p">[</span><span class="s1">&#39;vertices&#39;</span><span class="p">])</span>
        <span class="n">istart</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span>
        <span class="n">istart_year</span> <span class="o">=</span> <span class="n">istart</span><span class="o">.</span><span class="n">year</span>
        <span class="n">istart_mon</span> <span class="o">=</span> <span class="n">istart</span><span class="o">.</span><span class="n">month</span>
        <span class="n">istart_day</span> <span class="o">=</span> <span class="n">istart</span><span class="o">.</span><span class="n">day</span>
        <span class="n">nndays</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>    
        <span class="n">dtout</span> <span class="o">=</span> <span class="n">region_info</span><span class="p">[</span><span class="s1">&#39;interpolant&#39;</span><span class="p">][</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="c1">#time step in .nc </span>
        <span class="n">nt_out</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nudge_step</span><span class="p">)</span><span class="o">/</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">dtout</span><span class="p">))</span> <span class="c1">#output stride</span>
        <span class="n">variable_info</span> <span class="o">=</span> <span class="n">region_info</span><span class="p">[</span><span class="s1">&#39;interpolant&#39;</span><span class="p">][</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="n">variable_info</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vi</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;temperature&#39;</span><span class="p">:</span>
                <span class="n">tem_outside</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vi</span><span class="p">[</span><span class="s1">&#39;none_values&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;offset&#39;</span> <span class="ow">in</span> <span class="n">vi</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">tem_offset</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vi</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">vi</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;salinity&#39;</span><span class="p">:</span>
                <span class="n">sal_outside</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vi</span><span class="p">[</span><span class="s1">&#39;none_values&#39;</span><span class="p">])</span>        
        <span class="n">ncfile1</span> <span class="o">=</span> <span class="n">region_info</span><span class="p">[</span><span class="s1">&#39;interpolant&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>   
        <span class="n">ncfile1</span> <span class="o">=</span> <span class="n">ncfile1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># remove the quotation marks if they exist</span>
        <span class="n">irecout</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">irecout2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#Define limits for variables for sanity checks</span>
        <span class="n">tempmin</span><span class="o">=</span><span class="mi">0</span> 
        <span class="n">tempmax</span><span class="o">=</span><span class="mi">30</span>
        <span class="n">saltmin</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">saltmax</span><span class="o">=</span><span class="mi">37</span>
        <span class="n">vmag_max</span><span class="o">=</span><span class="mi">10</span> <span class="c1">#max. |u| or |v|</span>
        <span class="n">ssh_max</span><span class="o">=</span><span class="mi">8</span>   <span class="c1">#max. of |SSH|</span>
        <span class="n">imap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nnode</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">weights</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>      
       
        <span class="c1"># # instead of reading lat, lon from hgrid.ll, I can also convert </span>
        <span class="c1"># # hgrid.gr3 to lat, lon.</span>
        <span class="c1"># with open(&#39;hgrid.ll&#39;,&#39;r&#39;) as reader:</span>
        <span class="c1">#     lines = reader.readlines()            </span>
        <span class="c1"># xl=[]</span>
        <span class="c1"># yl=[]</span>
        <span class="c1"># for i in range(self.nnode):</span>
        <span class="c1">#     llist = lines[2+i].split()</span>
        <span class="c1">#     xl.append(float(llist[1]))</span>
        <span class="c1">#     yl.append(float(llist[2]))    </span>
            
        <span class="n">utm_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">node_x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">node_y</span><span class="p">])</span>
        <span class="n">lonlat</span><span class="o">=</span> <span class="n">utm2ll</span><span class="p">(</span><span class="n">utm_xy</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span> <span class="c1">#roms grid has lat, lon coordinates. </span>
        <span class="n">xl</span> <span class="o">=</span> <span class="n">lonlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yl</span> <span class="o">=</span> <span class="n">lonlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># the &#39;include2&#39; variable is replaced by &#39;weights&#39;</span>
        <span class="c1"># include indicates if spatial interpolation should be applied </span>
        <span class="c1"># include2=0 means skipping interpolation</span>
        <span class="c1"># with open(&#39;include.gr3&#39;,&#39;r&#39;) as reader:</span>
        <span class="c1">#     lines = reader.readlines()            </span>
        <span class="c1"># include2 = []</span>
        <span class="c1"># for i in range(self.nnode):</span>
        <span class="c1">#     llist = lines[2+i].split()</span>
        <span class="c1">#     include2.append(float(llist[-1]))</span>
        
        <span class="n">temperature</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">salinity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output_day</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">var_name</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;temperature&#39;</span><span class="p">:</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;salinity&#39;</span><span class="p">:</span> <span class="s1">&#39;salt&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;velocity_u&#39;</span><span class="p">:</span><span class="s1">&#39;uvel&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;velocity_v&#39;</span><span class="p">:</span><span class="s1">&#39;vvel&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;elevation&#39;</span><span class="p">:</span><span class="s1">&#39;ssh&#39;</span><span class="p">}</span>
        <span class="c1">#var_list = [var_name[v] for v in region_info[&#39;interpolant&#39;][&#39;variable&#39;]]</span>
        
        <span class="c1">#start = timer.time()</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nndays</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> 
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">istart_year</span><span class="p">,</span><span class="n">istart_mon</span><span class="p">,</span><span class="n">istart_day</span><span class="p">)</span> <span class="o">+</span> \
                <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">day</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">istart_year</span><span class="p">,</span><span class="n">istart_mon</span><span class="p">,</span><span class="n">istart_day</span><span class="p">)</span> <span class="o">-</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="n">d</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time out (days)=</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">day</span><span class="p">)</span>  
            <span class="k">for</span> <span class="n">hr</span> <span class="ow">in</span> <span class="n">hr_char</span><span class="p">:</span>
                <span class="n">ncfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%4d%02d%02d%s</span><span class="s2">.nc&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ncfile1</span><span class="p">,</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                                            <span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">,</span><span class="n">hr</span><span class="p">)</span>                
                <span class="n">ncdata</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span>
                <span class="c1">#print(&quot;time1=%f&quot;%(timer.time() - start))</span>
                
                <span class="k">if</span> <span class="n">d</span> <span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">hr</span> <span class="o">==</span> <span class="n">hr_char</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>                    
                    <span class="c1"># lon, lat = np.meshgrid(ncdata[&#39;lon&#39;].values,</span>
                    <span class="c1">#                        ncdata[&#39;lat&#39;].values)</span>
                    <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">ncdata</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                           <span class="n">ncdata</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">hnc</span> <span class="o">=</span> <span class="n">ncdata</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span>
                    <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="o">-</span><span class="mf">360e0</span> <span class="c1"># convert to our long</span>
                    <span class="c1">#Compute z-coord. (assuming eta=0)</span>
                    <span class="c1">#WARNING: In zm(), 1 is bottom; ilen is surface (SELFE convention)</span>
                    <span class="n">zm</span> <span class="o">=</span> <span class="o">-</span><span class="n">hnc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">ixlen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lat</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">iylen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lat</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">ilen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zm</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">hr</span><span class="o">==</span><span class="n">hr_char</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">ilo</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1">#5th record is 00:00 PST UCT-8</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ilo</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#there is an overlap between files</span>

                <span class="n">time</span> <span class="o">=</span> <span class="n">ncdata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                
                <span class="k">if</span> <span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span><span class="o">+</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;h&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">)</span> <span class="o">+</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;h&#39;</span><span class="p">):</span>
                    <span class="k">break</span>                
                
                <span class="k">if</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hr</span><span class="p">),</span><span class="s1">&#39;h&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial time in </span><span class="si">%s</span><span class="s2"> does not match the filename: </span><span class="si">%s</span><span class="s2">: modification will be applied &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">dt_adj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hr</span><span class="p">),</span><span class="s1">&#39;h&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ncdata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncdata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt_adj</span> 
                    <span class="n">time</span> <span class="o">=</span> <span class="n">ncdata</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span>

                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time</span><span class="p">[</span><span class="n">ilo</span><span class="p">:]:</span>
                    <span class="n">ctime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">-</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span> 
                    <span class="n">dt_in_days</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">86400.</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time out at hr stage (days)=</span><span class="si">{</span><span class="n">ctime</span><span class="si">}</span><span class="s2">, dt =</span><span class="si">{</span><span class="n">dt_in_days</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>                  
                    <span class="n">irecout</span> <span class="o">+=</span> <span class="mi">1</span> 

                    <span class="c1">#Make sure it2=ilo is output (output at precisely the time interval)</span>
                    <span class="c1"># Read T,S,u,v,SSH</span>
                    <span class="c1"># WARNING! Make sure the order of vertical indices is 1 </span>
                    <span class="c1"># at bottom, ilen at surface; revert if necessary!</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">irecout</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">nt_out</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">irecout2</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;irecount: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">irecout</span><span class="p">)</span>
                           
                    <span class="c1">#if  &#39;temp&#39; in var_list:</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">ncdata</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                        <span class="s1">&#39;lon&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;depth&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1">#if &#39;salt&#39; in var_list:</span>
                    <span class="n">salt</span> <span class="o">=</span> <span class="n">ncdata</span><span class="p">[</span><span class="s1">&#39;salt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                        <span class="s1">&#39;lon&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;depth&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>      
                    <span class="c1"># if &#39;uvel&#39; in var_list:</span>
                    <span class="c1">#     uvel = ncdata[&#39;uvel&#39;].sel(time=t).transpose(</span>
                    <span class="c1">#         &#39;lon&#39;,&#39;lat&#39;,&#39;depth&#39;).values[:,:,-1::-1] </span>
                    <span class="c1"># if &#39;vvel&#39; in var_list:</span>
                    <span class="c1">#     vvel = ncdata[&#39;vvel&#39;].sel(time=t).transpose(</span>
                    <span class="c1">#         &#39;lon&#39;,&#39;lat&#39;,&#39;depth&#39;).values[:,:,-1::-1]   </span>
                    <span class="c1"># if &#39;ssh&#39; in var_list:</span>
                    <span class="c1">#     ssh = ncdata[&#39;ssh&#39;].sel(time=t).transpose(</span>
                    <span class="c1">#         &#39;lon&#39;,&#39;lat&#39;)                                     </span>
            
                    <span class="n">kbp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ixlen</span><span class="p">,</span><span class="n">iylen</span><span class="p">))</span>  <span class="c1">#wet or dry flag</span>
                    
                    <span class="n">dry_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">salt</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">&gt;</span><span class="n">rjunk</span><span class="p">)</span> <span class="o">|</span> 
                                    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">salt</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="p">)</span>
                    <span class="n">kbp</span><span class="p">[</span><span class="n">dry_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dry_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">wet_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">kbp</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
                    
                    
                    <span class="n">klev0</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">salt</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,:]))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> 
                             <span class="p">(</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">wet_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">wet_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                    
                    <span class="c1">#print(&quot;time2=%f&quot;%(timer.time() - start))</span>
                    <span class="k">for</span> <span class="n">wi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">klev0</span><span class="p">)):</span> 
                        <span class="n">salt</span><span class="p">[</span><span class="n">wet_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">wi</span><span class="p">],</span><span class="n">wet_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">wi</span><span class="p">],:</span><span class="n">klev0</span><span class="p">[</span><span class="n">wi</span><span class="p">]]</span> <span class="o">=</span> \
                            <span class="n">salt</span><span class="p">[</span><span class="n">wet_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">wi</span><span class="p">],</span><span class="n">wet_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">wi</span><span class="p">],</span><span class="n">klev0</span><span class="p">[</span><span class="n">wi</span><span class="p">]]</span>
                        <span class="n">temp</span><span class="p">[</span><span class="n">wet_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">wi</span><span class="p">],</span><span class="n">wet_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">wi</span><span class="p">],:</span><span class="n">klev0</span><span class="p">[</span><span class="n">wi</span><span class="p">]]</span> <span class="o">=</span> \
                            <span class="n">temp</span><span class="p">[</span><span class="n">wet_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">wi</span><span class="p">],</span><span class="n">wet_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">wi</span><span class="p">],</span><span class="n">klev0</span><span class="p">[</span><span class="n">wi</span><span class="p">]]</span>   
                    
                    
                    <span class="c1"># for i in range(ixlen):</span>
                    <span class="c1">#     for j in range(iylen):</span>
                    <span class="c1">#         if (abs(salt[i,j,-1]&gt;rjunk)) or np.isnan(salt[i,j,-1]):</span>
                    <span class="c1">#             kbp[i,j]=-1 #dry</span>
                    <span class="c1">#         if kbp[i,j]==1:</span>
                    <span class="c1">#             #extend to the bottom</span>
                    <span class="c1">#             klev0 = np.where(~np.isnan(salt[i,j,:]))[0][0]</span>
                    <span class="c1">#             salt[i,j,:klev0] = salt[i,j,klev0]</span>
                    <span class="c1">#             temp[i,j,:klev0] = temp[i,j,klev0]</span>
                                <span class="c1"># if &#39;uvel&#39; in var_list:</span>
                                <span class="c1">#     uvel[i,j,:klev0] = uvel[i,j,klev0]</span>
                                <span class="c1"># if &#39;vvel&#39; in var_list:</span>
                                <span class="c1">#     uvel[i,j,:klev0] = uvel[i,j,klev0]                                    </span>
                            
                            <span class="c1"># double check to make sure there are no out of bound values</span>
                            <span class="c1"># if any(salt[i,j,:]&lt;saltmin) or \</span>
                            <span class="c1">#     any(salt[i,j,:]&gt;saltmax) or \</span>
                            <span class="c1">#     any(temp[i,j,:]&lt;tempmin) or \</span>
                            <span class="c1">#     any(temp[i,j,:]&gt;tempmax):</span>
                            <span class="c1">#     # any(abs(uvel[i,j,:]))&gt;vmag_max or \</span>
                            <span class="c1">#     # any(abs(vvel[i,j,:]))&gt;vmag_max or \</span>
                            <span class="c1">#     # abs(ssh[i,j])&gt;ssh_max</span>
                            <span class="c1">#     print(&quot;Fatal: no valid values:%s,%d,%d for salt or temp at&quot;</span>
                            <span class="c1">#           (ncfile,i,j))                                                      </span>

                    <span class="c1"># Compute S,T etc@ invalid pts based on nearest neighbor</span>
                    <span class="c1"># Search around neighborhood of a pt                    </span>
                    <span class="n">dryij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">kbp</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">dryi</span> <span class="o">=</span> <span class="n">dryij</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">dryj</span> <span class="o">=</span> <span class="n">dryij</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">wetij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">kbp</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">weti</span> <span class="o">=</span> <span class="n">wetij</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">wetj</span> <span class="o">=</span> <span class="n">wetij</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
                    
                    <span class="k">if</span> <span class="n">wetij</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no ROMS data available for: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">ctime</span><span class="p">))</span>
                        <span class="n">salt</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">salt</span><span class="p">)</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dryi</span><span class="p">,</span><span class="n">dryj</span><span class="p">):</span>
                            <span class="n">distij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">weti</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wetj</span><span class="o">-</span><span class="n">j</span><span class="p">)</span>                        
                            <span class="c1">#m = np.where(distij==min(distij))[0][0]</span>
                            <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distij</span><span class="p">)</span>    
                        <span class="c1"># salt[dryi,dryj,:] = salt[weti[m],wetj[m],:]</span>
                        <span class="c1"># temp[dryi,dryj,:] = temp[weti[m],wetj[m],:]</span>
                            <span class="n">salt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:]</span><span class="o">=</span><span class="n">salt</span><span class="p">[</span><span class="n">weti</span><span class="p">[</span><span class="n">m</span><span class="p">],</span><span class="n">wetj</span><span class="p">[</span><span class="n">m</span><span class="p">],:]</span>
                            <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:]</span><span class="o">=</span><span class="n">temp</span><span class="p">[</span><span class="n">weti</span><span class="p">[</span><span class="n">m</span><span class="p">],</span><span class="n">wetj</span><span class="p">[</span><span class="n">m</span><span class="p">],:]</span>    
                            <span class="c1">#uvel(i,j,:ilen)=uvel(weti[m],wetj[m],:ilen)</span>
                            <span class="c1">#vvel(i,j,:ilen)=vvel(weti[m],wetj[m],:ilen)</span>
                            <span class="c1">#ssh(i,j)=ssh(weti[m],wetj[m])</span>
                        
                        <span class="c1"># for i in range(ixlen):</span>
                        <span class="c1">#     for j in range(iylen):</span>
                        <span class="c1">#         if kbp[i,j]==-1:   # invalid pts (dry) </span>
                        <span class="c1">#             #Compute max possible tier # for neighborhood</span>
                        <span class="c1">#             mmax=max(i,ixlen-i-1,j,iylen-j-1)</span>
                                    
                        <span class="c1">#             m = 0 </span>
                        <span class="c1">#             i3 = np.nan</span>
                        <span class="c1">#             j3 = np.nan</span>
                        <span class="c1">#             #while True: #starting from (i,j) and search on both sides  </span>
                        <span class="c1">#             for m in range(0,mmax+1):                                  </span>
                        <span class="c1">#                 for ii in range(max(-m,-i),</span>
                        <span class="c1">#                                 min(m,ixlen-i-1)):</span>
                        <span class="c1">#                     i3 = max(0,min(ixlen-1,i+ii))</span>
                        <span class="c1">#                     for jj in range(max(-m,-j),</span>
                        <span class="c1">#                                     min(m,iylen-j-1)):</span>
                        <span class="c1">#                         j3=max(0,min(iylen-1,j+jj))</span>
                        <span class="c1">#                         if kbp[i3,j3]==1:</span>
                        <span class="c1">#                             i1=i3</span>
                        <span class="c1">#                             j1=j3</span>
                        <span class="c1">#                             break </span>
                        <span class="c1">#                     if kbp[i3,j3]==1:</span>
                        <span class="c1">#                          break</span>
                        <span class="c1">#                 if ~np.isnan(i3) and ~np.isnan(j3): </span>
                        <span class="c1">#                     if kbp[i3,j3]==1:</span>
                        <span class="c1">#                          break</span>
                        <span class="c1">#                 if m == mmax:</span>
                        <span class="c1">#                     print(&quot;Max. exhausted:%d,%d,%d&quot;%(</span>
                        <span class="c1">#                         i,j,mmax))</span>
                        <span class="c1">#                     print(&#39;kbp&#39;)</span>
                        <span class="c1">#                     for ii in range(ixlen):</span>
                        <span class="c1">#                         for jj in range(iylen):</span>
                        <span class="c1">#                             print(ii,jj,kbp(ii,jj))</span>
                        <span class="c1">#                     raise(&quot;Max. exhausted!&quot;)</span>
                        <span class="c1">#                 #m += 1 </span>
                                      
                        <span class="c1">#             salt[i,j,:ilen]=salt[i1,j1,:ilen]</span>
                        <span class="c1">#             temp[i,j,:ilen]=temp[i1,j1,:ilen]</span>
                                    <span class="c1"># double check to make sure there are no out of bound values</span>
                                    <span class="c1"># if any(salt[i,j,:]&lt;saltmin) or \</span>
                                    <span class="c1">#     any(salt[i,j,:]&gt;saltmax) or \</span>
                                    <span class="c1">#     any(temp[i,j,:]&lt;tempmin) or \</span>
                                    <span class="c1">#     any(temp[i,j,:]&gt;tempmax):</span>
                                    <span class="c1">#     print(&quot;Fatal: no valid values:%s,%d,%d for salt or temp at&quot;</span>
                                    <span class="c1">#           (ncfile,i,j))  </span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dealing with horizontal nan values!&quot;</span><span class="p">)</span> 
                        <span class="c1">#print(&quot;time3=%f&quot;%(timer.time() - start))</span>
                    
                    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">hr</span> <span class="o">==</span> <span class="n">hr_char</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">t</span><span class="o">==</span><span class="n">time</span><span class="p">[</span><span class="n">ilo</span><span class="p">]:</span>
                        <span class="n">ixy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nnode</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="n">wild</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">wild2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
                        <span class="n">arco</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nnode</span><span class="p">))</span>

                        <span class="n">x1</span> <span class="o">=</span> <span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">x2</span> <span class="o">=</span> <span class="n">lon</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">x3</span> <span class="o">=</span> <span class="n">lon</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="n">x4</span> <span class="o">=</span> <span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="n">y1</span> <span class="o">=</span> <span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">y2</span> <span class="o">=</span> <span class="n">lat</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">y3</span> <span class="o">=</span> <span class="n">lat</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="n">y4</span> <span class="o">=</span> <span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span>   
                        <span class="n">b1</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signa</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">x3</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">y3</span><span class="p">))</span>
                        <span class="n">b2</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signa</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">x3</span><span class="p">,</span><span class="n">x4</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">y3</span><span class="p">,</span><span class="n">y4</span><span class="p">))</span>
                       
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nnode</span><span class="p">):</span> 
                        <span class="c1">#for i in nodes:</span>
                            <span class="k">if</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">:</span>  <span class="c1"># the following code applies a spatial interpolation    </span>
                                         
                                <span class="n">a1</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signa</span><span class="p">(</span><span class="n">xl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">yl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">))</span>
                                <span class="n">a2</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signa</span><span class="p">(</span><span class="n">xl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">x2</span><span class="p">,</span><span class="n">x3</span><span class="p">,</span><span class="n">yl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">y2</span><span class="p">,</span><span class="n">y3</span><span class="p">))</span>
                                <span class="n">a3</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signa</span><span class="p">(</span><span class="n">xl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">x3</span><span class="p">,</span><span class="n">x4</span><span class="p">,</span><span class="n">yl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">y3</span><span class="p">,</span><span class="n">y4</span><span class="p">))</span>
                                <span class="n">a4</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signa</span><span class="p">(</span><span class="n">xl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">x4</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">yl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">y4</span><span class="p">,</span><span class="n">y1</span><span class="p">))</span>
                                <span class="n">rat</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">a1</span><span class="o">+</span><span class="n">a2</span><span class="o">+</span><span class="n">a3</span><span class="o">+</span><span class="n">a4</span><span class="o">-</span><span class="n">b1</span><span class="o">-</span><span class="n">b2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">b1</span><span class="o">+</span><span class="n">b2</span><span class="p">)</span>
                                <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rat</span><span class="o">&lt;</span><span class="n">small1</span><span class="p">)</span>
                                <span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">x1i</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])]</span>
                                <span class="n">x2i</span> <span class="o">=</span> <span class="n">x2</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])]</span>
                                <span class="n">x3i</span> <span class="o">=</span> <span class="n">x3</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])]</span>
                                <span class="n">x4i</span> <span class="o">=</span> <span class="n">x4</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])]</span>
                                <span class="n">y1i</span> <span class="o">=</span> <span class="n">y1</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])]</span>
                                <span class="n">y2i</span> <span class="o">=</span> <span class="n">y2</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])]</span>
                                <span class="n">y3i</span> <span class="o">=</span> <span class="n">y3</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])]</span>
                                <span class="n">y4i</span> <span class="o">=</span> <span class="n">y4</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])]</span>
                                <span class="n">a1i</span> <span class="o">=</span> <span class="n">a1</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])]</span>
                                <span class="n">a2i</span> <span class="o">=</span> <span class="n">a2</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])]</span>
                                <span class="n">a3i</span> <span class="o">=</span> <span class="n">a3</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])]</span>
                                <span class="n">a4i</span> <span class="o">=</span> <span class="n">a4</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])]</span>                                
                                
                                <span class="c1"># Find a triangle</span>
                                <span class="n">intri</span><span class="o">=</span><span class="mi">0</span>  <span class="c1">#flag: inside the triangle</span>
                                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="c1">#split quad</span>
                                  <span class="n">ap</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signa</span><span class="p">(</span><span class="n">xl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">x1i</span><span class="p">,</span><span class="n">x3i</span><span class="p">,</span><span class="n">yl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">y1i</span><span class="p">,</span><span class="n">y3i</span><span class="p">))</span>
                                  <span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>  <span class="c1">#nodes 1,2,3</span>
                                      <span class="n">bb</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signa</span><span class="p">(</span><span class="n">x1i</span><span class="p">,</span><span class="n">x2i</span><span class="p">,</span><span class="n">x3i</span><span class="p">,</span><span class="n">y1i</span><span class="p">,</span><span class="n">y2i</span><span class="p">,</span><span class="n">y3i</span><span class="p">))</span>
                                      <span class="n">wild</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">a1i</span><span class="o">+</span><span class="n">a2i</span><span class="o">+</span><span class="n">ap</span><span class="o">-</span><span class="n">bb</span><span class="p">)</span><span class="o">/</span><span class="n">bb</span>
                                      <span class="k">if</span> <span class="n">wild</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">&lt;</span><span class="n">small1</span><span class="o">*</span><span class="mi">5</span><span class="p">:</span>
                                          <span class="n">intri</span><span class="o">=</span><span class="mi">1</span>
                                          <span class="n">arco</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">a2i</span><span class="o">/</span><span class="n">bb</span><span class="p">))</span>
                                          <span class="n">arco</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">ap</span><span class="o">/</span><span class="n">bb</span><span class="p">))</span>
                                          <span class="k">break</span>
                                  <span class="k">else</span><span class="p">:</span> <span class="c1">#nodes 1,3,4</span>
                                      <span class="n">bb</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signa</span><span class="p">(</span><span class="n">x1i</span><span class="p">,</span><span class="n">x3i</span><span class="p">,</span><span class="n">x4i</span><span class="p">,</span><span class="n">y1i</span><span class="p">,</span><span class="n">y3i</span><span class="p">,</span><span class="n">y4i</span><span class="p">))</span>
                                      <span class="n">wild</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">a3i</span><span class="o">+</span><span class="n">a4i</span><span class="o">+</span><span class="n">ap</span><span class="o">-</span><span class="n">bb</span><span class="p">)</span><span class="o">/</span><span class="n">bb</span>
                                      <span class="k">if</span> <span class="n">wild</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">&lt;</span><span class="n">small1</span><span class="o">*</span><span class="mi">5</span><span class="p">:</span>
                                          <span class="n">intri</span><span class="o">=</span><span class="mi">2</span>
                                          <span class="n">arco</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">a3i</span><span class="o">/</span><span class="n">bb</span><span class="p">))</span>
                                          <span class="n">arco</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">a4i</span><span class="o">/</span><span class="n">bb</span><span class="p">))</span>
                                          <span class="k">break</span>
      
                                <span class="k">if</span><span class="p">(</span><span class="n">intri</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                                    <span class="k">raise</span><span class="p">(</span><span class="s1">&#39;Cannot find a triangle:&#39;</span><span class="p">,</span> <span class="n">wild</span><span class="p">)</span>
          
                                <span class="n">ixy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">intri</span>
                                <span class="n">arco</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">arco</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">arco</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]))</span>     
                            
                                <span class="c1"># for ix in range(ixlen-1):   </span>
                                <span class="c1">#     for iy in range(iylen-1):  </span>
                                <span class="c1">#         x1=lon[ix,iy]</span>
                                <span class="c1">#         x2=lon[ix+1,iy]</span>
                                <span class="c1">#         x3=lon[ix+1,iy+1]</span>
                                <span class="c1">#         x4=lon[ix,iy+1]</span>
                                <span class="c1">#         y1=lat[ix,iy]</span>
                                <span class="c1">#         y2=lat[ix+1,iy]</span>
                                <span class="c1">#         y3=lat[ix+1,iy+1]</span>
                                <span class="c1">#         y4=lat[ix,iy+1]</span>
                                <span class="c1">#         a1=abs(self.signa(xl[i],x1,x2,yl[i],y1,y2))</span>
                                <span class="c1">#         a2=abs(self.signa(xl[i],x2,x3,yl[i],y2,y3))</span>
                                <span class="c1">#         a3=abs(self.signa(xl[i],x3,x4,yl[i],y3,y4))</span>
                                <span class="c1">#         a4=abs(self.signa(xl[i],x4,x1,yl[i],y4,y1))</span>
                                <span class="c1">#         b1=abs(self.signa(x1,x2,x3,y1,y2,y3))</span>
                                <span class="c1">#         b2=abs(self.signa(x1,x3,x4,y1,y3,y4))</span>
                                <span class="c1">#         rat=abs(a1+a2+a3+a4-b1-b2)/(b1+b2)</span>
                                <span class="c1">#         if rat&lt;small1:</span>
                                <span class="c1">#           ixy[i,0]=ix</span>
                                <span class="c1">#           ixy[i,1]=iy</span>
                                <span class="c1">#           # Find a triangle</span>
                                <span class="c1">#           intri=0  #flag: inside the triangle</span>
                                <span class="c1">#           for l in range(2): #split quad</span>
                                <span class="c1">#             ap=abs(self.signa(xl[i],x1,x3,yl[i],y1,y3))</span>
                                <span class="c1">#             if l==0:  #nodes 1,2,3</span>
                                <span class="c1">#                 bb=abs(self.signa(x1,x2,x3,y1,y2,y3))</span>
                                <span class="c1">#                 wild[l]=abs(a1+a2+ap-bb)/bb</span>
                                <span class="c1">#                 if wild[l]&lt;small1*5:</span>
                                <span class="c1">#                     intri=1</span>
                                <span class="c1">#                     arco[0,i]=max(0.,min(1.,a2/bb))</span>
                                <span class="c1">#                     arco[1,i]=max(0.,min(1.,ap/bb))</span>
                                <span class="c1">#                     break</span>
                                <span class="c1">#             else: #nodes 1,3,4</span>
                                <span class="c1">#                 bb=abs(self.signa(x1,x3,x4,y1,y3,y4))</span>
                                <span class="c1">#                 wild[l]=abs(a3+a4+ap-bb)/bb</span>
                                <span class="c1">#                 if wild[l]&lt;small1*5:</span>
                                <span class="c1">#                     intri=2</span>
                                <span class="c1">#                     arco[0,i]=max(0.,min(1.,a3/bb))</span>
                                <span class="c1">#                     arco[1,i]=max(0.,min(1.,a4/bb))</span>
                                <span class="c1">#                     break</span>
                
                                <span class="c1">#           if(intri==0):</span>
                                <span class="c1">#               raise(&#39;Cannot find a triangle:&#39;, wild)</span>
                    
                                <span class="c1">#           ixy[i,2]=intri</span>
                                <span class="c1">#           arco[2,i]=max(0.,min(1.,1-arco[0,i]-arco[1,i]))</span>
                        <span class="c1"># the following step was calculated at every time step</span>
                        <span class="c1"># in the original code but can significanltyly slow down </span>
                        <span class="c1"># the python script.</span>
                        <span class="c1"># so it is only calculated once with the exception that</span>
                        <span class="c1"># the dry cells are filled at every time step</span>
                        <span class="n">i_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ixy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">i_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ixy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">npout</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_in</span><span class="p">)</span>
                        <span class="n">imap</span> <span class="o">=</span> <span class="n">i_in</span>
                        <span class="n">ix</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">[</span><span class="n">i_in</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                        <span class="n">iy</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">[</span><span class="n">i_in</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                        <span class="n">intri</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">[</span><span class="n">i_in</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                    
                        <span class="n">lev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">npout</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nvrt</span><span class="p">))</span><span class="o">*-</span><span class="mi">99</span>
                        <span class="n">vrat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npout</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nvrt</span><span class="p">))</span><span class="o">*-</span><span class="mi">99</span>
                        <span class="k">for</span> <span class="n">il</span><span class="p">,</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">i_in</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvrt</span><span class="p">):</span>
                                <span class="k">if</span><span class="p">(</span><span class="n">kbp</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="n">il</span><span class="p">],</span><span class="n">iy</span><span class="p">[</span><span class="n">il</span><span class="p">]]</span><span class="o">==-</span><span class="mi">1</span><span class="p">):</span> <span class="c1">#ROMS dry cell</span>
                                    <span class="n">lev</span><span class="p">[</span><span class="n">il</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ilen</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#</span>
                                    <span class="n">vrat</span><span class="p">[</span><span class="n">il</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">zm</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">kbp</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="n">il</span><span class="p">],</span><span class="n">iy</span><span class="p">[</span><span class="n">il</span><span class="p">]])]:</span>
                                    <span class="n">lev</span><span class="p">[</span><span class="n">il</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kbp</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="n">il</span><span class="p">],</span><span class="n">iy</span><span class="p">[</span><span class="n">il</span><span class="p">]]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="n">vrat</span><span class="p">[</span><span class="n">il</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">zm</span><span class="p">[</span><span class="n">ilen</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                                    <span class="n">lev</span><span class="p">[</span><span class="n">il</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ilen</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span>
                                    <span class="n">vrat</span><span class="p">[</span><span class="n">il</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">lev</span><span class="p">[</span><span class="n">il</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99</span> <span class="c1">#flag</span>
                                    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ilen</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">zm</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="ow">and</span> 
                                            <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">zm</span><span class="p">[</span><span class="n">kk</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                                            <span class="n">lev</span><span class="p">[</span><span class="n">il</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">kk</span>
                                            <span class="n">vrat</span><span class="p">[</span><span class="n">il</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">zm</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">zm</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">-</span><span class="n">zm</span><span class="p">[</span><span class="n">kk</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                                            <span class="k">break</span>                              
                                <span class="k">if</span> <span class="n">lev</span><span class="p">[</span><span class="n">il</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">99</span><span class="p">:</span>
                                    <span class="k">raise</span><span class="p">(</span><span class="s1">&#39;Cannot find a level:&#39;</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> 
                                          <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">k</span><span class="p">],</span>
                                          <span class="n">zm</span><span class="p">)</span>
                        <span class="n">kbp</span> <span class="o">=</span> <span class="n">kbp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                        <span class="n">lev</span> <span class="o">=</span> <span class="n">lev</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                        <span class="n">vrat</span> <span class="o">=</span> <span class="n">vrat</span><span class="o">.</span><span class="n">T</span>   
                        
                        <span class="n">wild2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nvrt</span><span class="p">,</span> <span class="n">npout</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>   <span class="c1">#initialize interpolation coefficients </span>
                        <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">ix</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvrt</span><span class="p">,</span> <span class="n">npout</span><span class="p">))</span> 
                        <span class="n">iy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">iy</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvrt</span><span class="p">,</span> <span class="n">npout</span><span class="p">))</span>
                        <span class="n">intri1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">intri</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">intri2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">intri</span><span class="o">==</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">i_in_1</span> <span class="o">=</span> <span class="n">i_in</span><span class="p">[</span><span class="n">intri1</span><span class="p">]</span>
                        <span class="n">i_in_2</span> <span class="o">=</span> <span class="n">i_in</span><span class="p">[</span><span class="n">intri2</span><span class="p">]</span>
                        <span class="c1">#print(&quot;time=%f&quot;%(timer.time() - start))</span>
                    
                        <span class="c1">#tempout=-999*np.ones((self.nvrt, self.nnode))</span>
                        <span class="c1">#saltout=-999*np.ones((self.nvrt, self.nnode)) </span>
                        <span class="n">tempout</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nvrt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnode</span><span class="p">))</span>
                        <span class="n">saltout</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nvrt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnode</span><span class="p">))</span> 
                        <span class="n">tempout</span><span class="p">[:,</span><span class="n">i_out</span><span class="p">]</span> <span class="o">=</span> <span class="n">tem_outside</span>
                        <span class="n">saltout</span><span class="p">[:,</span><span class="n">i_out</span><span class="p">]</span> <span class="o">=</span> <span class="n">sal_outside</span>   
                    
                    <span class="n">id_dry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">kbp</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#ROMS dry cell</span>
                    <span class="n">lev</span><span class="p">[:,</span><span class="n">id_dry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ilen</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">vrat</span><span class="p">[:,</span><span class="n">id_dry</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="c1"># id_deeper = np.where(self.z[i_in,:]&lt;zm[kbp[ix,iy]]) #deeper than ROMS</span>
                    <span class="c1"># lev[id_deeper] = int(kbp[ix,iy]-1)</span>
                    <span class="c1"># vrat[id_deeper] = 0</span>
                    <span class="c1"># id_shallower = np.where(self.z[i_in,:]&gt;=zm[ilen-1) #shallower than ROMS</span>
                    <span class="c1"># lev[id_shallower] = ilen-1-1</span>
                    <span class="c1"># vrat[id_shallower] = 1 </span>
                    
                    <span class="n">wild2</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">temp</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">lev</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">vrat</span><span class="p">)</span><span class="o">+</span><span class="n">temp</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">lev</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">vrat</span>
                    <span class="n">wild2</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">salt</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">lev</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">vrat</span><span class="p">)</span><span class="o">+</span><span class="n">salt</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">lev</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">vrat</span>
                    <span class="n">wild2</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">temp</span><span class="p">[</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">lev</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">vrat</span><span class="p">)</span><span class="o">+</span><span class="n">temp</span><span class="p">[</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">lev</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">vrat</span>
                    <span class="n">wild2</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">salt</span><span class="p">[</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">lev</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">vrat</span><span class="p">)</span><span class="o">+</span><span class="n">salt</span><span class="p">[</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">lev</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">vrat</span>
                    <span class="n">wild2</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">temp</span><span class="p">[</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">iy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">lev</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">vrat</span><span class="p">)</span><span class="o">+</span><span class="n">temp</span><span class="p">[</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">iy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">lev</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">vrat</span>
                    <span class="n">wild2</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">salt</span><span class="p">[</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">iy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">lev</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">vrat</span><span class="p">)</span><span class="o">+</span><span class="n">salt</span><span class="p">[</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">iy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">lev</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">vrat</span>
                    <span class="n">wild2</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">temp</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">lev</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">vrat</span><span class="p">)</span><span class="o">+</span><span class="n">temp</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">lev</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">vrat</span>
                    <span class="n">wild2</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">salt</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">lev</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">vrat</span><span class="p">)</span><span class="o">+</span><span class="n">salt</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">lev</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">vrat</span>
                                        
                    <span class="n">tempout</span><span class="p">[:,</span><span class="n">i_in</span><span class="p">[</span><span class="n">intri1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">wild2</span><span class="p">[:,</span><span class="n">intri1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">arco</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i_in_1</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="n">wild2</span><span class="p">[:,</span><span class="n">intri1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">arco</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i_in_1</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="n">wild2</span><span class="p">[:,</span><span class="n">intri1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">arco</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i_in_1</span><span class="p">]</span>
                    
                    <span class="n">saltout</span><span class="p">[:,</span><span class="n">i_in</span><span class="p">[</span><span class="n">intri1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">wild2</span><span class="p">[:,</span><span class="n">intri1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">arco</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i_in_1</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="n">wild2</span><span class="p">[:,</span><span class="n">intri1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">arco</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i_in_1</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="n">wild2</span><span class="p">[:,</span><span class="n">intri1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">arco</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i_in_1</span><span class="p">]</span>
                        
                                    <span class="c1">#             if intri==1:</span>
                    <span class="c1">#                 tempout[k,i] = wild2[0,0]*arco[0,i] + \</span>
                    <span class="c1">#                               wild2[1,0]*arco[1,i] + \</span>
                    <span class="c1">#                               wild2[2,0]*arco[2,i]</span>
                    <span class="c1">#                 saltout[k,i] = wild2[0,1]*arco[0,i] + \</span>
                    <span class="c1">#                               wild2[1,1]*arco[1,i] + \</span>
                    <span class="c1">#                               wild2[2,1]*arco[2,i]</span>
                    <span class="c1">#             else:</span>
                    <span class="c1">#                 tempout[k,i] = wild2[0,0]*arco[0,i] + \</span>
                    <span class="c1">#                               wild2[2,0]*arco[1,i] + \</span>
                    <span class="c1">#                               wild2[3,0]*arco[2,i]</span>
                    <span class="c1">#                 saltout[k,i] = wild2[0,1]*arco[0,i] + \</span>
                    <span class="c1">#                               wild2[2,1]*arco[1,i] + \</span>
                    <span class="c1">#                               wild2[3,1]*arco[2,i]                        </span>
                   
                    <span class="n">tempout</span><span class="p">[:,</span><span class="n">i_in</span><span class="p">[</span><span class="n">intri2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">wild2</span><span class="p">[:,</span><span class="n">intri2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">arco</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i_in_2</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="n">wild2</span><span class="p">[:,</span><span class="n">intri2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">arco</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i_in_2</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="n">wild2</span><span class="p">[:,</span><span class="n">intri2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">arco</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i_in_2</span><span class="p">]</span>
                    
                    <span class="n">saltout</span><span class="p">[:,</span><span class="n">i_in</span><span class="p">[</span><span class="n">intri2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">wild2</span><span class="p">[:,</span><span class="n">intri2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">arco</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i_in_2</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="n">wild2</span><span class="p">[:,</span><span class="n">intri2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">arco</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i_in_2</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="n">wild2</span><span class="p">[:,</span><span class="n">intri2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">arco</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i_in_2</span><span class="p">]</span>   
                    
                    <span class="c1">#print(&quot;time4=%f&quot;%(timer.time() - start))</span>
                    
                    <span class="c1">#Correct near surface T bias</span>
                    <span class="n">idST</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">kbp</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">]</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">i_in</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span><span class="o">&gt;-</span><span class="mi">10</span><span class="p">))</span>
                    <span class="n">tempout</span><span class="p">[</span><span class="n">idST</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i_in</span><span class="p">[</span><span class="n">idST</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span><span class="o">=</span><span class="n">tempout</span><span class="p">[</span><span class="n">idST</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i_in</span><span class="p">[</span><span class="n">idST</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span><span class="o">-</span><span class="mi">1</span>
    
                    <span class="c1">#if i==23293 and k == self.nvrt-1:</span>
                    <span class="c1"># if npout==0 and k == self.nvrt-1 and irecout2==100:</span>
                    <span class="c1">#     import pdb</span>
                    <span class="c1">#     pdb.set_trace()</span>
                    <span class="c1"># Check</span>
                    <span class="c1"># if (tempout[k,i]&lt;tempmin or tempout[k,i]&gt;tempmax or \</span>
                    <span class="c1">#     saltout[k,i]&lt;saltmin or saltout[k,i]&gt;saltmax):</span>
                    <span class="c1">#     raise(&quot;Interpolated values invalid:&quot;,i,k,</span>
                    <span class="c1">#       tempout[k,i],saltout[k,i])  </span>
                    
                    <span class="c1"># for i in range(self.nnode):</span>
                    <span class="c1"># #for i in nodes:</span>
                    <span class="c1">#     if np.isnan(ixy[i,0]) or np.isnan(ixy[i,1]):</span>
                    <span class="c1">#         #print(&quot;Cannot find a parent element:&quot;,i)</span>
                    <span class="c1">#         tempout[:,i]=tem_outside</span>
                    <span class="c1">#         saltout[:,i]=sal_outside                    </span>
                    <span class="c1">#         if weights[i]!=0.:</span>
                    <span class="c1">#             print(&quot;This node is not covered by the data&quot;, i)            </span>
                    <span class="c1">#     else:        </span>
                    <span class="c1">#         npout+=1</span>
                    <span class="c1">#         imap[npout]=i</span>
                    <span class="c1">#         ix=int(ixy[i,0])</span>
                    <span class="c1">#         iy=int(ixy[i,1])</span>
                    <span class="c1">#         intri=int(ixy[i,2])</span>
                    <span class="c1">#         #Find vertical level</span>
                    <span class="c1">#         tempout[:,i]=-999</span>
                            
                    <span class="c1">#         for k in range(self.nvrt):</span>
                    <span class="c1">#             if(kbp[ix,iy]==-1): #ROMS dry cell</span>
                    <span class="c1">#                 lev=ilen-1-1  #</span>
                    <span class="c1">#                 vrat=1</span>
                    <span class="c1">#             elif self.z[i,k]&lt;=zm[int(kbp[ix,iy])]:</span>
                    <span class="c1">#                 lev=int(kbp[ix,iy])-1</span>
                    <span class="c1">#                 vrat=0</span>
                    <span class="c1">#             elif self.z[i,k]&gt;=zm[ilen-1]:</span>
                    <span class="c1">#                 lev=ilen-1-1</span>
                    <span class="c1">#                 vrat=1</span>
                    <span class="c1">#             else:</span>
                    <span class="c1">#                 lev=-99 #flag</span>
                    <span class="c1">#                 for kk in range(ilen-1):</span>
                    <span class="c1">#                     if (self.z[i,k]&gt;=zm[kk] and </span>
                    <span class="c1">#                         self.z[i,k]&lt;=zm[kk+1]):</span>
                    <span class="c1">#                         lev=kk</span>
                    <span class="c1">#                         vrat=(zm[kk]-self.z[i,k])/(zm[kk]-zm[kk+1])</span>
                    <span class="c1">#                         break                              </span>
                    <span class="c1">#             if lev==-99:</span>
                    <span class="c1">#                 raise(&#39;Cannot find a level:&#39;, i,k, self.z[i,k],</span>
                    <span class="c1">#                       zm)</span>
                                    
                    <span class="c1">#             wild2 = np.zeros((4,2))</span>
                    <span class="c1">#             wild2[0,0]=temp[ix,iy,lev]*(1-vrat)+temp[ix,iy,lev+1]*vrat</span>
                    <span class="c1">#             wild2[0,1]=salt[ix,iy,lev]*(1-vrat)+salt[ix,iy,lev+1]*vrat</span>
                    <span class="c1">#             wild2[1,0]=temp[ix+1,iy,lev]*(1-vrat)+temp[ix+1,iy,lev+1]*vrat</span>
                    <span class="c1">#             wild2[1,1]=salt[ix+1,iy,lev]*(1-vrat)+salt[ix+1,iy,lev+1]*vrat</span>
                    <span class="c1">#             wild2[2,0]=temp[ix+1,iy+1,lev]*(1-vrat)+temp[ix+1,iy+1,lev+1]*vrat</span>
                    <span class="c1">#             wild2[2,1]=salt[ix+1,iy+1,lev]*(1-vrat)+salt[ix+1,iy+1,lev+1]*vrat</span>
                    <span class="c1">#             wild2[3,0]=temp[ix,iy+1,lev]*(1-vrat)+temp[ix,iy+1,lev+1]*vrat</span>
                    <span class="c1">#             wild2[3,1]=salt[ix,iy+1,lev]*(1-vrat)+salt[ix,iy+1,lev+1]*vrat</span>
                
                    <span class="c1">#             if intri==1:</span>
                    <span class="c1">#                 tempout[k,i] = wild2[0,0]*arco[0,i] + \</span>
                    <span class="c1">#                               wild2[1,0]*arco[1,i] + \</span>
                    <span class="c1">#                               wild2[2,0]*arco[2,i]</span>
                    <span class="c1">#                 saltout[k,i] = wild2[0,1]*arco[0,i] + \</span>
                    <span class="c1">#                               wild2[1,1]*arco[1,i] + \</span>
                    <span class="c1">#                               wild2[2,1]*arco[2,i]</span>
                    <span class="c1">#             else:</span>
                    <span class="c1">#                 tempout[k,i] = wild2[0,0]*arco[0,i] + \</span>
                    <span class="c1">#                               wild2[2,0]*arco[1,i] + \</span>
                    <span class="c1">#                               wild2[3,0]*arco[2,i]</span>
                    <span class="c1">#                 saltout[k,i] = wild2[0,1]*arco[0,i] + \</span>
                    <span class="c1">#                               wild2[2,1]*arco[1,i] + \</span>
                    <span class="c1">#                               wild2[3,1]*arco[2,i]</span>
                    <span class="c1">#             #if i==23293 and k == self.nvrt-1:</span>
                    <span class="c1">#             # if npout==0 and k == self.nvrt-1 and irecout2==100:</span>
                    <span class="c1">#             #     import pdb</span>
                    <span class="c1">#             #     pdb.set_trace()</span>
                    <span class="c1">#             # Check</span>
                    <span class="c1">#             # if (tempout[k,i]&lt;tempmin or tempout[k,i]&gt;tempmax or \</span>
                    <span class="c1">#             #     saltout[k,i]&lt;saltmin or saltout[k,i]&gt;saltmax):</span>
                    <span class="c1">#             #     raise(&quot;Interpolated values invalid:&quot;,i,k,</span>
                    <span class="c1">#             #       tempout[k,i],saltout[k,i])                         </span>
                
                    <span class="c1">#             #Correct near surface T bias</span>
                    <span class="c1">#             if kbp[ix,iy]!=-1 and self.z[i,k]&gt;-10:</span>
                    <span class="c1">#                 tempout[k,i]=tempout[k,i]-1</span>
                
                    <span class="c1">#             #Enforce lower bound for temp. for eqstate</span>
                    <span class="c1">#             tempout[k,i]=max(0.,tempout[k,i])  </span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;applying spatial interpolation!&quot;</span><span class="p">)</span>          
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;outputting at day &quot;</span><span class="p">,</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mi">86400</span><span class="p">,</span> <span class="n">npout</span><span class="p">)</span> 
                    
                    <span class="c1"># only save the nodes with valid values. </span>
                    <span class="n">tempout_in</span> <span class="o">=</span> <span class="p">[</span><span class="n">temp_t</span><span class="p">[</span><span class="n">imap</span><span class="p">[:</span><span class="n">npout</span><span class="p">]]</span> <span class="k">for</span> <span class="n">temp_t</span> <span class="ow">in</span> <span class="n">tempout</span><span class="p">]</span>
                    <span class="n">saltout_in</span> <span class="o">=</span> <span class="p">[</span><span class="n">salt_t</span><span class="p">[</span><span class="n">imap</span><span class="p">[:</span><span class="n">npout</span><span class="p">]]</span> <span class="k">for</span> <span class="n">salt_t</span> <span class="ow">in</span> <span class="n">saltout</span><span class="p">]</span>
                    <span class="n">temperature</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tempout_in</span><span class="p">)</span>
                    <span class="n">salinity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">saltout_in</span><span class="p">)</span>
                    <span class="n">output_day</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mi">86400</span><span class="p">)</span>
                    <span class="c1"># if output_day[-1] == 350.625:</span>
                    <span class="c1">#     import pdb</span>
                    <span class="c1">#     pdb.set_trace()</span>
                    <span class="n">nudge_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nudge_step</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_day</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">output_day</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">output_day</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nudge_step</span><span class="o">+</span><span class="mf">0.1</span><span class="p">)</span><span class="o">/</span><span class="mi">24</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current time step </span><span class="si">{</span><span class="n">output_day</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> and previous </span><span class="si">{</span><span class="n">output_day</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> file</span><span class="si">{</span><span class="n">ncfile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The difference between current and previous time step is greater than assigned stride&#39;</span><span class="p">)</span>
                    <span class="c1">#print(&quot;time5=%f&quot;%(timer.time() - start))</span>
        <span class="c1"># return weights, output_day, [temperature, salinity], \</span>
        <span class="c1">#     imap[:npout].astype(int)+1   #schism is one-based  </span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
        <span class="n">salinity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">salinity</span><span class="p">)</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">temperature</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># [var,time,node_map, nvrt]</span>
        <span class="n">salinity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">salinity</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>        
        <span class="c1">#Enforce lower bound for temp. for eqstate</span>
        <span class="n">temperature</span><span class="p">[</span><span class="n">temperature</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span> <span class="mi">0</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;reorganizing matrix!&quot;</span><span class="p">)</span>  
        <span class="c1">#print(&quot;time=%f&quot;%(timer.time() - start))</span>
        <span class="k">return</span> <span class="n">weights</span><span class="p">,</span> <span class="p">[</span><span class="n">temperature</span><span class="p">,</span> <span class="n">salinity</span><span class="p">],</span> \
            <span class="n">imap</span><span class="p">[:</span><span class="n">npout</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">output_day</span>   <span class="c1">#schism is one-based </span></div>

    
<div class="viewcode-block" id="nudging.signa"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging.signa">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">signa</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">x3</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">y3</span><span class="p">):</span>
        <span class="n">signa</span><span class="o">=</span><span class="p">((</span><span class="n">x1</span><span class="o">-</span><span class="n">x3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y3</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y3</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">signa</span></div>
    
<div class="viewcode-block" id="nudging.reorder_variables"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging.reorder_variables">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">reorder_variables</span><span class="p">(</span><span class="n">var_info</span><span class="p">,</span><span class="n">var_ordered_list</span><span class="p">):</span>
        <span class="c1">#reorder observed variables according to [temperature,salinity]</span>
        <span class="c1">#var_ordered_list = np.array([&#39;temperature&#39;,&#39;salinity&#39;,&#39;elevation&#39;])  # this list can be extended if new nudging variables are required.</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">var_ordered_list</span> <span class="o">==</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_info</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">var_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span></div>
       
<div class="viewcode-block" id="nudging.gen_nudge_obs"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging.gen_nudge_obs">[docs]</a>    <span class="k">def</span> <span class="nf">gen_nudge_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_info</span><span class="p">):</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">1e3</span>  <span class="c1">#when weights are less than cutoff, they will be set to zero</span>
        <span class="n">weights</span><span class="p">,</span> <span class="n">obs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_region_weight</span><span class="p">(</span><span class="n">region_info</span><span class="p">[</span><span class="s1">&#39;attribute&#39;</span><span class="p">],</span>
                                                 <span class="n">region_info</span><span class="p">[</span><span class="s1">&#39;vertices&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs_df</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">obs_sites</span> <span class="o">=</span> <span class="n">obs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">weights</span><span class="o">&lt;</span><span class="n">weights</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="n">cutoff</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">region_info</span><span class="p">[</span><span class="s1">&#39;interpolant&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>        
        <span class="n">variable_info</span> <span class="o">=</span> <span class="n">region_info</span><span class="p">[</span><span class="s1">&#39;interpolant&#39;</span><span class="p">][</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span> 
        <span class="n">weights_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">imap_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">values_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variable_info</span><span class="p">:</span>
            <span class="n">empty_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">none_values</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;none_values&#39;</span><span class="p">]</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_data</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>                                     
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">obs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c1"># this is in case there are multiple variables listed in the datafile</span>
                <span class="n">vdata</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># only one variable listed in the file (but can be at multiple locations)</span>
                <span class="n">vdata</span> <span class="o">=</span> <span class="n">obs</span>            
            
            <span class="c1">#if np.any(np.isnan(vdata)):  </span>
            <span class="k">if</span> <span class="n">vdata</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vdata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span> <span class="c1"># pandas array</span>
                    <span class="c1"># if none_values == &#39;interpolate&#39;: #other fillna options possible.                        </span>
                    <span class="c1">#     vdata = vdata.interpolate()    </span>
                    <span class="c1"># elif none_values == &#39;ambient&#39;:  #fillna with -9999. </span>
                    <span class="c1">#     vdata = vdata.fillna(-9999.)</span>
                    <span class="c1"># elif none_values == &#39;ignore&#39;: #ignore the entire series when there is any none</span>
                    <span class="c1">#     empty_data = True           </span>
                    <span class="k">if</span> <span class="n">none_values</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;nan values detected for </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="n">none_values</span> <span class="o">==</span> <span class="s1">&#39;ambient&#39;</span><span class="p">:</span>
                        <span class="n">vdata</span> <span class="o">=</span> <span class="n">vdata</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">9999.</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Fill nan option </span><span class="si">%s</span><span class="s2"> is not implemented&quot;</span><span class="o">%</span><span class="n">none_values</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vdata</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span> <span class="c1"># multiple obs data,typically multiple stations</span>
                    <span class="n">vdata</span> <span class="o">=</span> <span class="n">vdata</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
                    <span class="c1"># if none_values == &#39;interpolate&#39;:</span>
                    <span class="c1">#     vdata = vdata.interpolate(axis=0)</span>
                    <span class="c1"># elif none_values = &#39;ambient&#39;:</span>
                    <span class="c1">#     vdata = vdata.fillna(-9999.)</span>
                    <span class="c1"># elif non_values == &#39;ignore&#39;:</span>
                    <span class="c1">#     vdata = vdata.dropna(axis=1,how=&#39;any&#39;) </span>
                    <span class="c1"># if len(vdata.column)==0:</span>
                    <span class="c1">#     empty_data = True</span>
                    <span class="k">if</span> <span class="n">none_values</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;nan values detected for </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="n">none_values</span> <span class="o">==</span> <span class="s1">&#39;ambient&#39;</span><span class="p">:</span>
                        <span class="n">vdata</span> <span class="o">=</span> <span class="n">vdata</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">9999.</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Fill nan option </span><span class="si">%s</span><span class="s2"> is not implemented&quot;</span><span class="o">%</span><span class="n">none_values</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vdata</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">dataarray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span> <span class="c1">#xarray</span>
                    <span class="n">vdata</span> <span class="o">=</span> <span class="n">vdata</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;site&#39;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
                    <span class="c1"># if none_values == &#39;interpolate&#39;:</span>
                    <span class="c1">#     vdata = vdata.interpolate_na(dim=&#39;time&#39;)</span>
                    <span class="k">if</span> <span class="n">none_values</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;nan values detected for </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="n">none_values</span> <span class="o">==</span> <span class="s1">&#39;ambient&#39;</span><span class="p">:</span>
                        <span class="n">vdata</span> <span class="o">=</span> <span class="n">vdata</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">9999.</span><span class="p">)</span>
                    <span class="c1"># elif none_values == &#39;ignore&#39;:</span>
                    <span class="c1">#     vdata = vdata.dropna(dim=&#39;site&#39;,how=&#39;any&#39;) </span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vdata</span><span class="o">.</span><span class="n">site</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">empty_data</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vdata</span><span class="p">,</span><span class="n">xr</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">dataarray</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span> <span class="c1"># the only possibility this happens is that the variable is not in the dataset</span>
                    <span class="n">empty_data</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">if</span> <span class="n">empty_data</span><span class="p">:</span>
                <span class="n">weights_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nnode</span><span class="p">)</span>
                <span class="n">imap_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="c1"># empty array</span>
                <span class="n">values_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="n">weights_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights_v</span><span class="p">)</span>
                <span class="n">values_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values_v</span><span class="p">)</span>
                <span class="n">imap_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imap_v</span><span class="p">)</span> 
                <span class="k">continue</span>     
            
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vdata</span><span class="p">,</span><span class="n">xr</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">dataarray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
                <span class="n">vdata_sites</span> <span class="o">=</span> <span class="n">vdata</span><span class="o">.</span><span class="n">site</span>
                <span class="c1"># the weights is ordered accodring to obs_sites;</span>
                <span class="c1"># and it will need to be reordered according to vdata.site</span>
                <span class="n">w_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">vdata</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obs_sites</span><span class="o">==</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">w_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">idx</span><span class="p">,:])</span>                        
                <span class="n">weights_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">w_list</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> 
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vdata</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">vdata_sites</span> <span class="o">=</span> <span class="n">vdata</span><span class="o">.</span><span class="n">columns</span>
                <span class="c1"># the weights is ordered accodring to obs_sites;</span>
                <span class="c1"># and it will need to be reordered according to vdata.site</span>
                <span class="n">w_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">vdata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obs_sites</span><span class="o">==</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">w_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">idx</span><span class="p">,:])</span>
                <span class="n">weights_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">w_list</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> 
            <span class="k">else</span><span class="p">:</span> <span class="c1"># no adjustment for weights for a single obs site</span>
                <span class="n">vdata_sites</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;single_site&#39;</span><span class="p">]</span>
                <span class="n">weights_v</span> <span class="o">=</span> <span class="n">weights</span>
            
            <span class="n">imap_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">weights_v</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>            
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_df</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vdata_sites</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># multiple sites    </span>
                <span class="nb">print</span><span class="p">(</span><span class="n">vdata_sites</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">obs_df</span><span class="p">)</span>                
                <span class="n">obs_x</span> <span class="o">=</span> <span class="n">obs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">vdata_sites</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">obs_y</span> <span class="o">=</span> <span class="n">obs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">vdata_sites</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>                
                                     
                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span><span class="s1">&#39;nearest&#39;</span><span class="p">:</span>
                    <span class="n">nn_id</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_x</span><span class="p">[</span><span class="n">imap_v</span><span class="p">],</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">node_y</span><span class="p">[</span><span class="n">imap_v</span><span class="p">]):</span>
                        <span class="n">dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="n">obs_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="n">obs_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                        <span class="n">nn_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dist</span><span class="o">==</span><span class="n">dist</span><span class="o">.</span><span class="n">min</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">values_v</span> <span class="o">=</span> <span class="n">vdata</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">nn_id</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>    
                <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;inverse_distance&#39;</span><span class="p">:</span>
                    <span class="n">obs_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">obs_x</span><span class="p">,</span><span class="n">obs_y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">values_v</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vdata</span><span class="p">,</span><span class="n">xr</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">dataarray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">vdata</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]:</span>
                            <span class="n">vals</span> <span class="o">=</span> <span class="n">vdata</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                            <span class="n">vals</span><span class="p">[</span><span class="n">vals</span><span class="o">==-</span><span class="mf">9999.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                            <span class="n">obs_loc_t</span> <span class="o">=</span> <span class="n">obs_loc</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vals</span><span class="p">)]</span> <span class="c1"># removing nan points</span>
                            <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vals</span><span class="p">)]</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">vals</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;negative values detected in </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">: &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span><span class="n">name</span><span class="p">)</span><span class="o">+</span> 
                                                 <span class="n">vals</span><span class="p">[</span><span class="n">vals</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])</span>
                            <span class="c1"># removing all the nans.                            </span>
                            <span class="n">invdisttree</span> <span class="o">=</span> <span class="n">Interp2D</span><span class="o">.</span><span class="n">Invdisttree</span><span class="p">(</span><span class="n">obs_loc_t</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span>
                                           <span class="n">leafsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">node_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">node_x</span><span class="p">[</span><span class="n">imap_v</span><span class="p">],</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">node_y</span><span class="p">[</span><span class="n">imap_v</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
                            <span class="n">values_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">invdisttree</span><span class="p">(</span><span class="n">node_xy</span><span class="p">,</span> <span class="n">nnear</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

                    <span class="k">else</span><span class="p">:</span>    
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">vdata</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                            <span class="n">vals</span> <span class="o">=</span> <span class="n">vdata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                            <span class="n">vals</span><span class="p">[</span><span class="n">vals</span><span class="o">==-</span><span class="mf">9999.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                            <span class="n">obs_loc_t</span> <span class="o">=</span> <span class="n">obs_loc</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vals</span><span class="p">)]</span> <span class="c1"># removing nan points</span>
                            <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vals</span><span class="p">)]</span>     
                            <span class="k">if</span> <span class="p">(</span><span class="n">vals</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;negative values detected in </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">: &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span><span class="n">name</span><span class="p">)</span><span class="o">+</span> 
                                                 <span class="n">vals</span><span class="p">[</span><span class="n">vals</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">invdisttree</span> <span class="o">=</span> <span class="n">Interp2D</span><span class="o">.</span><span class="n">Invdisttree</span><span class="p">(</span><span class="n">obs_loc_t</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span>
                                           <span class="n">leafsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">node_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">node_x</span><span class="p">[</span><span class="n">imap_v</span><span class="p">],</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">node_y</span><span class="p">[</span><span class="n">imap_v</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
                            <span class="n">values_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">invdisttree</span><span class="p">(</span><span class="n">node_xy</span><span class="p">,</span> <span class="n">nnear</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                     <span class="k">raise</span> <span class="ne">NotImplementedError</span>                  
            <span class="k">else</span><span class="p">:</span> <span class="c1"># single site</span>
                <span class="n">imap_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">weights_v</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">values_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">vdata</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                           <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imap_v</span><span class="p">),</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">vdata</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>                 
                
            <span class="n">weights_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights_v</span><span class="p">)</span>
            <span class="n">values_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values_v</span><span class="p">)</span>
            <span class="n">imap_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imap_v</span><span class="p">)</span>          
                
        <span class="c1"># for v in variable_info:</span>
        <span class="c1">#     if v in obs.keys():</span>
        <span class="c1">#         vdata = obs[v]  </span>
        <span class="c1">#         if region_info[&#39;type&#39;] == &#39;single_obs&#39;:                               </span>
        <span class="c1">#             if np.any(np.isnan(vdata)):  </span>
        <span class="c1">#                 if none_values == &#39;interpolate&#39;: #other fillna options possible.                        </span>
        <span class="c1">#                     if isinstance(vdata, pd.core.series.Series): # pandas array</span>
        <span class="c1">#                         vdata = vdata.interpolate()</span>
        <span class="c1">#                     elif isinstance(vdata, xr.core.dataarray.DataArray): #xarray</span>
        <span class="c1">#                         vdata = vdata.interpolate_na(dim=&#39;time&#39;)</span>
        <span class="c1">#                     weights_v = weights</span>
        <span class="c1">#                     imap_v = np.where(weights_v&gt;0)[0]</span>
        <span class="c1">#                     values_v = np.broadcast_to(vdata.values,</span>
        <span class="c1">#                                                (len(imap_v),</span>
        <span class="c1">#                                                 len(vdata))).T</span>
        <span class="c1">#                 elif none_values == &#39;ignore&#39;: #ignore the entire series when there is any none</span>
        <span class="c1">#                     weights_v = np.zeros(weights)</span>
        <span class="c1">#                     imap_v = np.array([]) # empty array</span>
        <span class="c1">#                     values_v = np.array([])</span>
        <span class="c1">#             else:</span>
        <span class="c1">#                 weights_v = weights</span>
        <span class="c1">#                 imap_v = np.where(weights_v&gt;0)[0]</span>
        <span class="c1">#                 values_v = np.broadcast_to(vdata.values,</span>
        <span class="c1">#                                            (len(imap_v),</span>
        <span class="c1">#                                             len(vdata))).T  </span>
        <span class="c1">#         elif region_info[&#39;type&#39;] == &#39;multi_obs&#39;:  #multiple observational points</span>
        <span class="c1">#             # multiple input should be stored in netcdf format only. </span>
        <span class="c1">#             if np.any(np.isnan(vdata)): </span>
        <span class="c1">#                 vdata = vdata.dropna(dim=&#39;site&#39;,how=&#39;all&#39;)</span>
        <span class="c1">#                 if none_values == &#39;interpolate&#39;:</span>
        <span class="c1">#                     vdata = vdata.interpolate_na(dim=&#39;time&#39;)</span>
        <span class="c1">#                 elif none_values == &#39;ignore&#39;:</span>
        <span class="c1">#                     vdata = vdata.dropna(dim=&#39;site&#39;,how=&#39;any&#39;)</span>
                            
        <span class="c1">#                 inc_site = []</span>
        <span class="c1">#                 for s in obs.site.values:</span>
        <span class="c1">#                     if s in vdata.site.values:</span>
        <span class="c1">#                         inc_site.append(True)</span>
        <span class="c1">#                     else:</span>
        <span class="c1">#                         inc_site.append(False)</span>
        <span class="c1">#                 weights_v = weights[inc_site,:].sum(axis=0)</span>
        <span class="c1">#             else:</span>
        <span class="c1">#                 weights_v = weights</span>
        <span class="c1">#             imap_v = np.where(weights_v&gt;0)[0]                </span>
        <span class="c1">#             obs_x = obs.x.sel(site=vdata.site).values.astype(float)</span>
        <span class="c1">#             obs_y = obs.y.sel(site=vdata.site).values.astype(float)</span>
                                     
        <span class="c1">#             if method ==&#39;nearest&#39;:</span>
        <span class="c1">#                 nn_id = []</span>
        <span class="c1">#                 for nx, ny in zip(self.node_x[imap_v],</span>
        <span class="c1">#                                   self.node_y[imap_v]):</span>
        <span class="c1">#                     dist = (nx-obs_x)**2 + (ny-obs_y)**2</span>
        <span class="c1">#                     nn_id.append(np.where(dist==dist.min())[0][0])</span>
        <span class="c1">#                 values_v = vdata.isel(site=nn_id).values    </span>
        <span class="c1">#             elif method == &#39;inverse_distance&#39;:</span>
        <span class="c1">#                 obs_loc = np.array([obs_x,obs_y]).T</span>
        <span class="c1">#                 values_v = []</span>
        <span class="c1">#                 for t in vdata.time:</span>
        <span class="c1">#                     vals = vdata.sel(time=t).values</span>
        <span class="c1">#                     invdisttree = Interp2D.Invdisttree(obs_loc, vals,</span>
        <span class="c1">#                                    leafsize=10, stat=1)</span>
        <span class="c1">#                     node_xy = np.array([self.node_x[imap_v],</span>
        <span class="c1">#                                         self.node_y[imap_v]]).T</span>
        <span class="c1">#                     values_v.append(invdisttree(node_xy, nnear=4, p=2))</span>
        <span class="c1">#             else:</span>
        <span class="c1">#                  raise NotImplementedError   </span>
        <span class="c1">#     else:</span>
        <span class="c1">#         weights_v = []</span>
        <span class="c1">#         values_v = []</span>
        <span class="c1">#         imap_v = []</span>
        <span class="c1">#     weights_list.append(weights_v)</span>
        <span class="c1">#     values_list.append(values_v)</span>
        <span class="c1">#     imap_list.append(imap_v) </span>
     
        <span class="k">return</span> <span class="n">weights_list</span><span class="p">,</span> <span class="n">values_list</span><span class="p">,</span> <span class="n">imap_list</span>          </div>

<div class="viewcode-block" id="nudging.read_data"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging.read_data">[docs]</a>    <span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;csv&#39;</span><span class="p">):</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span><span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span>
            <span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>   
            <span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="o">&gt;=</span>
                       <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">))</span> <span class="o">&amp;</span>
                      <span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="o">&lt;=</span>
                       <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">))]</span>
            <span class="c1"># time interpolation</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nudge_step</span><span class="p">)</span><span class="o">.</span><span class="n">nearest</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span><span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The input time series may not cover the </span><span class="se">\</span>
<span class="s1">                      entire nudging period: check </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;nc&#39;</span><span class="p">):</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>     
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obs</span>        </div>

<div class="viewcode-block" id="nudging.gen_region_weight"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging.gen_region_weight">[docs]</a>    <span class="k">def</span> <span class="nf">gen_region_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">vertices</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">vertices</span><span class="p">:</span>
                <span class="n">inpoly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_vertices</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_x</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_x</span><span class="p">[</span><span class="n">inpoly</span><span class="p">],</span> 
                                           <span class="bp">self</span><span class="o">.</span><span class="n">node_y</span><span class="p">[</span><span class="n">inpoly</span><span class="p">])):</span>
                <span class="n">weights</span><span class="p">[</span><span class="n">inpoly</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
            <span class="n">obs_df</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute</span><span class="p">[</span><span class="s1">&#39;xy&#39;</span><span class="p">],</span><span class="nb">str</span><span class="p">):</span> <span class="c1"># multiple points</span>
                <span class="k">if</span> <span class="n">attribute</span><span class="p">[</span><span class="s1">&#39;xy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;nc&#39;</span><span class="p">):</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">attribute</span><span class="p">[</span><span class="s1">&#39;xy&#39;</span><span class="p">])</span>
                    <span class="n">x0</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="n">y0</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="n">obs_sites</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">attribute</span><span class="p">[</span><span class="s1">&#39;xy&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;csv&#39;</span><span class="p">):</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">attribute</span><span class="p">[</span><span class="s1">&#39;xy&#39;</span><span class="p">])</span>
                    <span class="n">x0</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">y0</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">obs_sites</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">obs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span><span class="n">obs_sites</span><span class="p">,</span>
                                       <span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span>
                                       <span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">})</span>
                <span class="n">obs_df</span> <span class="o">=</span> <span class="n">obs_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;site&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x0</span><span class="p">,</span><span class="n">y0</span> <span class="o">=</span> <span class="n">attribute</span><span class="p">[</span><span class="s1">&#39;xy&#39;</span><span class="p">]</span>
                <span class="n">obs_df</span> <span class="o">=</span> <span class="p">[]</span>
                
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_x</span><span class="p">)])</span>
                <span class="n">norm_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)):</span>
                    <span class="n">weights_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_weights</span><span class="p">([</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">],[</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">],</span><span class="n">attribute</span><span class="p">)</span>
                    <span class="c1"># perhaps other more sophisticated normalization can be used here instead</span>
                    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights_c</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">norm_factor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights_c</span><span class="p">)</span> <span class="c1"># if 1 exceeds</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_x</span><span class="p">)</span>
                <span class="n">norm_factor</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">vertices</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="n">inpoly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_vertices</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_x</span><span class="p">[</span><span class="n">inpoly</span><span class="p">],</span> 
                                               <span class="bp">self</span><span class="o">.</span><span class="n">node_y</span><span class="p">[</span><span class="n">inpoly</span><span class="p">])):</span>  
                    <span class="n">weights</span><span class="p">[</span><span class="n">inpoly</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_weights</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span>
                                                                <span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">norm_factor</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_x</span><span class="p">,</span> 
                                               <span class="bp">self</span><span class="o">.</span><span class="n">node_y</span><span class="p">)):</span>
                    <span class="n">weights</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_weights</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span>
                                                          <span class="n">norm_factor</span><span class="p">)</span>    
        
        <span class="k">return</span> <span class="n">weights</span><span class="p">,</span> <span class="n">obs_df</span></div>

<div class="viewcode-block" id="nudging.construct_weights"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging.construct_weights">[docs]</a>    <span class="k">def</span> <span class="nf">construct_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">norm_factor</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attribute</span><span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span> <span class="c1"># multiple points </span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_weights</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">],[</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">],</span><span class="n">attribute</span><span class="p">)</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">*</span><span class="n">norm_factor</span><span class="o">/</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span>
                        <span class="n">attribute</span><span class="p">[</span><span class="s1">&#39;time_scale&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>  
                    <span class="k">return</span> <span class="n">weights</span> <span class="c1"># multiple weights</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># float or int</span>
                    <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_weights</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">],</span>
                                                   <span class="p">[</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">],</span><span class="n">attribute</span><span class="p">)</span>
                    <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="o">/</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span>
                        <span class="n">attribute</span><span class="p">[</span><span class="s1">&#39;time_scale&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">weight</span> <span class="c1"># single weight          </span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> kernel not implemented&quot;</span><span class="o">%</span><span class="n">attribute</span><span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">])</span></div>
                
<div class="viewcode-block" id="nudging.plot"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">imap</span><span class="p">,</span><span class="n">values</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nnode</span><span class="p">)</span>
        <span class="n">v</span><span class="p">[</span><span class="n">imap</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
        <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">plot_nodes</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">col</span></div>
    
<div class="viewcode-block" id="nudging.gaussian_weights"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging.gaussian_weights">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">gaussian_weights</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="n">xyc</span><span class="p">,</span><span class="n">attribute</span><span class="p">):</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xyc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xyc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>  <span class="c1">#can be multiple points</span>
        <span class="c1"># calculate weights however normalization is needed</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">r2</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">attribute</span><span class="p">[</span><span class="s1">&#39;length_scale&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">weight</span></div>

<div class="viewcode-block" id="nudging.in_vertices"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.nudging.in_vertices">[docs]</a>    <span class="k">def</span> <span class="nf">in_vertices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vertices</span><span class="p">):</span>        
        <span class="n">Polygon</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>        
        <span class="n">inpoly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_gpd</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">p</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">inpoly</span>  </div></div>


<div class="viewcode-block" id="create_arg_parser"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.create_arg_parser">[docs]</a><span class="k">def</span> <span class="nf">create_arg_parser</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Create hotstart for a schism run&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--yaml_fn&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;yaml file for nudging&#39;</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--suffix&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;suffix for generated nudging files&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--crs&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;The projection system for the mesh&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span></div>
    
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_nudging.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># User inputs override the yaml file inputs.  </span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">create_arg_parser</span><span class="p">()</span> 
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    
    <span class="n">nudging</span> <span class="o">=</span> <span class="n">nudging</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">yaml_fn</span><span class="p">,</span><span class="n">crs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                                     <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">)</span>
    <span class="n">nudging</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">()</span>
    <span class="n">nudging</span><span class="o">.</span><span class="n">create_nudging</span><span class="p">()</span></div>
           
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">home</a>|&nbsp;</li>
        <li><a href="../../search.html">search</a>|&nbsp;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">schimpy.schism_nudging</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, California Department of Water Resources.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.2.
    </div>
  </body>
</html>