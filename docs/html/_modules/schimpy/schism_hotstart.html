
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>schimpy.schism_hotstart &#8212; schimpy 1.2.1+1.ge1e6d39.dirty documentation</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../index.html"><img src="../../_static/logo6.png" border="0" alt="Bay-Delta SELFE Tools"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">home</a>|&nbsp;</li>
        <li><a href="../../search.html">search</a>|&nbsp;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">schimpy.schism_hotstart</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for schimpy.schism_hotstart</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot; </span>
<span class="sd">Module for creating a schism hotstart file</span>

<span class="sd">Options:</span>
<span class="sd">1. Centering:</span>
<span class="sd">    * node2D: node (2D surface)</span>
<span class="sd">    * node3D: node at whole level </span>
<span class="sd">    * edge: edge center at whole level (mainly for horizontal velocties)</span>
<span class="sd">    * elem: element center at whole level (mainly for vertical velocity)</span>
<span class="sd">    * prism: prism center (for tracers); three different variables tr_el, tr_nd,</span>
<span class="sd">    * tr_el need to be generated for the hotstart.nc file. </span>
<span class="sd">        *  tr_nd = tr_nd0 (on nodes)</span>
<span class="sd">        *  tr_el (on element at middle level)</span>
<span class="sd">2. Initializer:</span>
<span class="sd">    * text_init: 2D map input from either *.prop or *.ic files; require input text file. </span>
<span class="sd">    * simple_trend: can either be a number or an equation that depends on x (lat) and y(lon). e.g,: 0.97 + 1.e-5*x </span>
<span class="sd">    * patch_init: regional-based method. Polygon shapefile input required.</span>
<span class="sd">    * extrude_casts: 3D nearest neighbourhood interpolation based on Polaris cruise transects. </span>
<span class="sd">    * obs_points: interpolated from 1D (time series of) observational points.</span>

<span class="sd">Required data files:</span>
<span class="sd">    * param.in</span>
<span class="sd">    * hgrid.gr3</span>
<span class="sd">    * vgrid.in</span>
<span class="sd">    * hotstart.yaml and input files defined in the yaml file. </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">distance</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># import from schimpy</span>

<span class="kn">from</span> <span class="nn">schimpy.schism_mesh</span> <span class="kn">import</span> <span class="n">read_mesh</span><span class="p">,</span> <span class="n">write_mesh</span><span class="p">,</span> <span class="n">SchismMeshGr3Reader</span>
<span class="kn">from</span> <span class="nn">schimpy</span> <span class="kn">import</span> <span class="n">geo_tools</span>

<div class="viewcode-block" id="SCHISMHotstart"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.SCHISMHotstart">[docs]</a><span class="k">class</span> <span class="nc">SCHISMHotstart</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Mock object &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>
    
<div class="viewcode-block" id="read_hotstart"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.read_hotstart">[docs]</a><span class="k">def</span> <span class="nf">read_hotstart</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Mock method to read existing hotstart&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="hotstart"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.hotstart">[docs]</a><span class="k">class</span> <span class="nc">hotstart</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to generate hotstart initial condition for SCHISM </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># will change these into yaml file on</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yaml_fn</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;TEM&#39;</span><span class="p">,</span> <span class="s1">&#39;SAL&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># read input from yaml files;</span>
        <span class="c1"># create elev.ic if it does not exist or not used as an input</span>
        <span class="c1"># the modules to turn on.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yaml_fn</span> <span class="o">=</span> <span class="n">yaml_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nc_dataset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="n">modules</span>
        <span class="k">if</span> <span class="s1">&#39;param_in&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param_in</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;param_in&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param_in</span> <span class="o">=</span> <span class="s2">&quot;param.in&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;proj4&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proj4</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;proj4&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proj4</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">ntracers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">irange_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr_mname</span> <span class="o">=</span> \
            <span class="n">n_tracers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_in</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">)</span>

<div class="viewcode-block" id="hotstart.read_yaml"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.hotstart.read_yaml">[docs]</a>    <span class="k">def</span> <span class="nf">read_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        read yaml and load mesh grid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yaml_fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
        <span class="n">hotstart_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;hotstart&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">hotstart_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">hotstart_info</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hgrid_fn</span> <span class="o">=</span> <span class="n">hotstart_info</span><span class="p">[</span><span class="s1">&#39;hgrid_input_file&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vgrid_fn</span> <span class="o">=</span> <span class="n">hotstart_info</span><span class="p">[</span><span class="s1">&#39;vgrid_input_file&#39;</span><span class="p">]</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hotstart_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1"># remove these items from the list.</span>
        <span class="n">rfl</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hgrid_input_file&#39;</span><span class="p">,</span> <span class="s1">&#39;vgrid_input_file&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rfl</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">variables</span></div>

<div class="viewcode-block" id="hotstart.create_hotstart"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.hotstart.create_hotstart">[docs]</a>    <span class="k">def</span> <span class="nf">create_hotstart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">()</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">read_mesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hgrid_fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vgrid_fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_depths</span><span class="p">()</span>
        <span class="c1">#v = self.variables[1]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;creating hotstart for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_3D_field</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nc_dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialize_netcdf</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nc_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nc_dataset</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="c1"># correct wet/dry cells depending on water level (eta2 value):mostly not needed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wet_dry_check</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_to_schism</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nc_dataset</span></div>

<div class="viewcode-block" id="hotstart.generate_3D_field"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.hotstart.generate_3D_field">[docs]</a>    <span class="k">def</span> <span class="nf">generate_3D_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">):</span>
        <span class="n">v_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>
        <span class="n">kwargs_options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;SED&#39;</span> <span class="ow">in</span> <span class="n">variable</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;Nbed&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;sediment.in&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sediment_fn</span> <span class="o">=</span> <span class="s2">&quot;sediment.in&quot;</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">read_param_in</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sediment_fn</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Nbed</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Nbed&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                        <span class="s2">&quot;sediment.in is required if SED module is turned on&quot;</span><span class="p">)</span>
            <span class="n">kwargs_options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;Nbed&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nbed</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">kwargs_options</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">VariableField</span><span class="p">(</span><span class="n">v_meta</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">depths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj4</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs_options</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">VariableField</span><span class="p">(</span><span class="n">v_meta</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">depths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj4</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">var</span><span class="o">.</span><span class="n">GenerateField</span><span class="p">()</span></div>

<div class="viewcode-block" id="hotstart.initialize_netcdf"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.hotstart.initialize_netcdf">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_netcdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_turbulence</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nc_dataset</span><span class="p">:</span>  <span class="c1"># if the dataset is empty, initialize the nc file</span>
            <span class="c1">#self.n_tracers = [h.info[k][&#39;centering&#39;] for k in h.variables].count(&#39;prism_c&#39;)</span>
            <span class="n">idry_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_elems</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">idry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_nodes</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">idry_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_edges</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]),</span>
                             <span class="s1">&#39;iths&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                             <span class="s1">&#39;ifile&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                             <span class="s1">&#39;idry_e&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;elem&#39;</span><span class="p">,</span> <span class="n">idry_e</span><span class="p">),</span>
                             <span class="s1">&#39;idry_s&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;side&#39;</span><span class="p">,</span> <span class="n">idry_s</span><span class="p">),</span>
                             <span class="s1">&#39;idry&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">idry</span><span class="p">)})</span>
            <span class="c1"># coords={&#39;one&#39;:range(1),</span>
            <span class="c1"># &#39;elem&#39;:range(self.mesh.n_elems()),</span>
            <span class="c1"># &#39;node&#39;:range(self.mesh.n_nodes()),</span>
            <span class="c1"># &#39;side&#39;:range(self.mesh.n_edges())})</span>
            <span class="c1"># Now apply default setting for  q2, xl, dfv,dfh,dfq1,dfq2,</span>
            <span class="c1"># SED3D_dp, SED3D_rough, SED3D_bed, SED3D_bedfrac</span>
            <span class="k">if</span> <span class="n">default_turbulence</span><span class="p">:</span>
                <span class="c1"># Turbulent kinetic energy</span>
                <span class="n">ar_name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;q2&#39;</span><span class="p">,</span> <span class="s1">&#39;xl&#39;</span><span class="p">,</span> <span class="s1">&#39;dfv&#39;</span><span class="p">,</span> <span class="s1">&#39;dfh&#39;</span><span class="p">,</span> <span class="s1">&#39;dfq1&#39;</span><span class="p">,</span> <span class="s1">&#39;dfq2&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ar_name</span><span class="p">:</span>
                    <span class="n">ds_ar</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="s1">&#39;nVert&#39;</span><span class="p">],</span>
                                               <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_nodes</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_vert_levels</span><span class="p">)))})</span>
                    <span class="c1"># coords={&#39;node&#39;:range(self.mesh.n_nodes()),</span>
                    <span class="c1"># &#39;nVert&#39;:range(self.mesh.n_vert_levels)})</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ds_ar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nc_dataset</span> <span class="o">=</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="hotstart.wet_dry_check"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.hotstart.wet_dry_check">[docs]</a>    <span class="k">def</span> <span class="nf">wet_dry_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        modify idry_e, idry, and idry_s based on eta2 and water depth. </span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="c1">#        if hasattr(self.nc_dataset,&#39;eta2&#39;):</span>
<span class="c1">#            z = self.mesh.build_z(elev=self.nc_dataset[&#39;eta2&#39;])</span>
<span class="c1">#        else:</span>
<span class="c1">#            z = self.mesh.build_z()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nc_dataset</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depths</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="s1">&#39;nVert&#39;</span><span class="p">])</span>
        <span class="n">dry_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depths</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">dry_nodes</span><span class="p">):</span>
            <span class="n">idry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nc_dataset</span><span class="p">[</span><span class="s1">&#39;idry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">idry</span><span class="p">[</span><span class="n">dry_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># dry cells have positive z values</span>
            <span class="n">idry_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">idry</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">edges</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]])</span>  <span class="c1"># node to side</span>
            <span class="c1"># if there is one dry node, the element is dry?</span>
            <span class="n">idry_s</span><span class="p">[</span><span class="n">idry_s</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">idry_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">idry</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elems</span><span class="p">])</span>  <span class="c1"># node to elem</span>
            <span class="c1"># if there is one dry node, the side is dry?</span>
            <span class="n">idry_e</span><span class="p">[</span><span class="n">idry_e</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nc_dataset</span><span class="p">[</span><span class="s1">&#39;idry_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">idry_s</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nc_dataset</span><span class="p">[</span><span class="s1">&#39;idry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">idry</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nc_dataset</span><span class="p">[</span><span class="s1">&#39;idry_e&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">idry_e</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="hotstart.compute_depths"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.hotstart.compute_depths">[docs]</a>    <span class="k">def</span> <span class="nf">compute_depths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate points in 3-D grid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span>
        <span class="n">vert_grid</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vmesh</span>
        <span class="n">nvrt</span> <span class="o">=</span> <span class="n">vert_grid</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;nvrt&#39;</span><span class="p">]</span>
        <span class="n">depths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_nodes</span><span class="p">(),</span> <span class="n">nvrt</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vert_grid</span><span class="o">.</span><span class="n">ivcor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nvrt</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">):</span>
                <span class="n">hmod2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">kbps</span> <span class="o">=</span> <span class="n">vert_grid</span><span class="o">.</span><span class="n">kbps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">depths</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">kbps</span><span class="p">:]</span> <span class="o">=</span> <span class="n">hmod2</span> <span class="o">*</span> <span class="n">vert_grid</span><span class="o">.</span><span class="n">sigma</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">nvrt</span><span class="o">-</span><span class="n">kbps</span><span class="p">]</span>
                <span class="n">depths</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">kbps</span><span class="p">]</span> <span class="o">=</span> <span class="n">depths</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">kbps</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depths</span> <span class="o">=</span> <span class="n">depths</span>
        <span class="k">elif</span> <span class="n">vert_grid</span><span class="o">.</span><span class="n">ivcor</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">h_s</span> <span class="o">=</span> <span class="n">vert_grid</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;h_s&#39;</span><span class="p">]</span>
            <span class="n">h_c</span> <span class="o">=</span> <span class="n">vert_grid</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;h_c&#39;</span><span class="p">]</span>
            <span class="n">kz</span> <span class="o">=</span> <span class="n">vert_grid</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;kz&#39;</span><span class="p">]</span>
            <span class="n">c_s</span> <span class="o">=</span> <span class="n">vert_grid</span><span class="o">.</span><span class="n">c_s</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">):</span>
                <span class="c1"># TODO: Maybe add surface elevation?</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="c1"># S-level</span>
                <span class="n">hmod2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">h_s</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vert_grid</span><span class="o">.</span><span class="n">sigma</span><span class="p">):</span>
                    <span class="n">k_a</span> <span class="o">=</span> <span class="n">kz</span> <span class="o">+</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">hmod2</span> <span class="o">&lt;=</span> <span class="n">h_c</span><span class="p">:</span>
                        <span class="n">depths</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k_a</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">hmod2</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">depths</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k_a</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_c</span> <span class="o">*</span> <span class="n">s</span> <span class="o">+</span> <span class="p">(</span><span class="n">hmod2</span> <span class="o">-</span> <span class="n">h_c</span><span class="p">)</span> <span class="o">*</span> <span class="n">c_s</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="c1"># Z-level</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vert_grid</span><span class="o">.</span><span class="n">ztot</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">depths</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depths</span> <span class="o">=</span> <span class="n">depths</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span><span class="p">(</span><span class="s2">&quot;Not supported ivcor&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="hotstart.map_to_schism"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.hotstart.map_to_schism">[docs]</a>    <span class="k">def</span> <span class="nf">map_to_schism</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        map the hotstart variable to the variable names required by SCHISM </span>
<span class="sd">        hotstart file. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">param_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_in</span>
        <span class="n">ntracers</span><span class="p">,</span> <span class="n">ntrs</span><span class="p">,</span> <span class="n">irange_tr</span><span class="p">,</span> <span class="n">tr_mname</span> <span class="o">=</span> <span class="n">n_tracers</span><span class="p">(</span>
            <span class="n">param_in</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">)</span>
        <span class="n">tr_mname_el</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_el&quot;</span> <span class="o">%</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tr_mname</span><span class="p">]</span>
        <span class="n">tr_mname_nd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_nd&quot;</span> <span class="o">%</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tr_mname</span><span class="p">]</span>
        <span class="n">tr_mname_nd0</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_nd0&quot;</span> <span class="o">%</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tr_mname</span><span class="p">]</span>
        <span class="n">schism_hotstart_var</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;eta2&#39;</span><span class="p">:</span> <span class="s1">&#39;elevation&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;we&#39;</span><span class="p">:</span> <span class="s1">&#39;velocity_w&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;su2&#39;</span><span class="p">:</span> <span class="s1">&#39;velocity_u&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;sv2&#39;</span><span class="p">:</span> <span class="s1">&#39;velocity_v&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;tr_el&#39;</span><span class="p">:</span> <span class="n">tr_mname_el</span><span class="p">,</span>
                               <span class="s1">&#39;tr_nd&#39;</span><span class="p">:</span> <span class="n">tr_mname_nd</span><span class="p">,</span>
                               <span class="s1">&#39;tr_nd0&#39;</span><span class="p">:</span> <span class="n">tr_mname_nd0</span><span class="p">}</span>
        <span class="n">nc_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nc_dataset</span>
        <span class="c1">#v_keys =list(nc_dataset.data_vars)</span>
        <span class="n">mapping_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;temperature_nd&#39;</span><span class="p">:</span> <span class="s1">&#39;TEM_nd&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;temperature_nd0&#39;</span><span class="p">:</span> <span class="s1">&#39;TEM_nd0&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;temperature_el&#39;</span><span class="p">:</span> <span class="s1">&#39;TEM_el&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;salinity_nd&#39;</span><span class="p">:</span> <span class="s1">&#39;SAL_nd&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;salinity_nd0&#39;</span><span class="p">:</span> <span class="s1">&#39;SAL_nd0&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;salinity_el&#39;</span><span class="p">:</span> <span class="s1">&#39;SAL_el&#39;</span><span class="p">}</span>

        <span class="n">nc_dataset</span> <span class="o">=</span> <span class="n">nc_dataset</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">mapping_dict</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">var_values</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">schism_hotstart_var</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">schism_hotstart_var</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_values</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">nc_dataset</span> <span class="o">=</span> <span class="n">nc_dataset</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">var_values</span><span class="p">:</span> <span class="n">key</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">var_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">nc_dataset</span><span class="p">[</span><span class="n">var_values</span><span class="p">][</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_values</span><span class="p">])</span>
                <span class="n">var_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">var_temp</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">var_dim</span> <span class="o">=</span> <span class="n">nc_dataset</span><span class="p">[</span><span class="n">var_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">dims</span>
                <span class="c1">#dim_values = [nc_dataset[var_values[0]][dim].values for dim in var_dim]</span>
                <span class="n">var_dim</span> <span class="o">=</span> <span class="n">var_dim</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;ntracers&#39;</span><span class="p">,)</span>
                <span class="c1"># dim_values.append(range(len(var_values)))</span>
                <span class="c1">#coords = {}</span>
                <span class="c1"># for vd,dv in zip(var_dim,dim_values):</span>
                <span class="c1">#coords[vd] = dv</span>
                <span class="n">v1_sub</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="n">var_dim</span><span class="p">,</span> <span class="n">var_temp</span><span class="p">)})</span>
                <span class="c1"># coords=coords)</span>
                <span class="n">nc_dataset</span> <span class="o">=</span> <span class="n">nc_dataset</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">v1_sub</span><span class="p">)</span>
                <span class="n">nc_dataset</span> <span class="o">=</span> <span class="n">nc_dataset</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">var_values</span><span class="p">)</span>

        <span class="n">nc_dataset</span><span class="p">[</span><span class="s1">&#39;tracer_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr_mname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nc_dataset</span> <span class="o">=</span> <span class="n">nc_dataset</span></div></div>


<div class="viewcode-block" id="VariableField"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.VariableField">[docs]</a><span class="k">class</span> <span class="nc">VariableField</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class initializing each varaible for the hotstart file </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v_meta</span><span class="p">,</span> <span class="n">vname</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">depths</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">proj4</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">centering</span> <span class="o">=</span> <span class="n">v_meta</span><span class="p">[</span><span class="s1">&#39;centering&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variable_name</span> <span class="o">=</span> <span class="n">vname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depths</span> <span class="o">=</span> <span class="n">depths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proj4</span> <span class="o">=</span> <span class="n">proj4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_edges</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_edges</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_nodes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_nodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_elems</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_elems</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_vert_levels</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_vert_levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">get_centers_of_sides</span><span class="p">()[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elem</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">get_centers_of_elements</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elems</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">elems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">v_meta</span><span class="p">[</span><span class="s1">&#39;initializer&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ini_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">v_meta</span><span class="p">[</span><span class="s1">&#39;initializer&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">vname</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;SED3D_bed&#39;</span><span class="p">,</span> <span class="s1">&#39;SED3D_bedfrac&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nbed</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Nbed&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nbed</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_grid</span><span class="p">()</span>  <span class="c1"># grid can be nodes/elems/edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_hgrid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_vgrid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hgrid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vgrid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hgrid_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vgrid_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">vname</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;SED3D_bed&#39;</span><span class="p">,</span> <span class="s1">&#39;SED3D_bedfrac&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_sdim</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># sediment dimension</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sdim_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">2</span><span class="p">]</span>

<div class="viewcode-block" id="VariableField.get_grid"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.VariableField.get_grid">[docs]</a>    <span class="k">def</span> <span class="nf">get_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Getting the number and coordinates of horizontal nodes/elems/edges for </span>
<span class="sd">        different centering options and return them as grid.   </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;node3D&#39;</span><span class="p">,</span> <span class="s1">&#39;node2D&#39;</span><span class="p">,</span> <span class="s1">&#39;edge&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;elem&#39;</span><span class="p">,</span> <span class="s1">&#39;prism&#39;</span><span class="p">,</span> <span class="s1">&#39;bed&#39;</span><span class="p">,</span> <span class="s1">&#39;bedfrac&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">centering</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;centering option </span><span class="si">%s</span><span class="s1"> is not implemented</span>
<span class="s1">                                      availabel options are: &#39;&#39;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">centering</span> <span class="o">+</span>
                                      <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="p">))</span>
        <span class="n">centering_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;node3D&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;node&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">),</span>
                                        <span class="s1">&#39;nVert&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vert_levels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depths</span><span class="p">)},</span>
                             <span class="s1">&#39;edge&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_edges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge</span><span class="p">),</span>
                                      <span class="s1">&#39;nVert&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vert_levels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depths</span><span class="p">)},</span>
                             <span class="s1">&#39;elem&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;elem&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_elems</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elem</span><span class="p">),</span>         <span class="c1"># on element but at whole level: mainly for w</span>
                                      <span class="s1">&#39;nVert&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vert_levels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depths</span><span class="p">)},</span>
                             <span class="s1">&#39;prism&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;node&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">),</span>        <span class="c1"># on prism center: mainly for tracers; first average from nodes to centers and then then average to prism center</span>
                                       <span class="s1">&#39;nVert&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vert_levels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depths</span><span class="p">)},</span>
                             <span class="s1">&#39;node2D&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;node&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">),</span>
                                        <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)},</span>
                             <span class="s1">&#39;bed&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;elem&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_elems</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elem</span><span class="p">),</span>
                                     <span class="s1">&#39;Nbed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nbed</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                     <span class="s1">&#39;MBEDP&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;layer thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;layer age&#39;</span><span class="p">,</span> <span class="s1">&#39;layer porosity&#39;</span><span class="p">])},</span>
                             <span class="s1">&#39;bedfrac&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;elem&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_elems</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elem</span><span class="p">),</span>
                                         <span class="s1">&#39;Nbed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nbed</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                         <span class="s1">&#39;nsed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}}</span>
        <span class="k">return</span> <span class="n">centering_options</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">centering</span><span class="p">]</span></div>

<div class="viewcode-block" id="VariableField.initializer_options"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.VariableField.initializer_options">[docs]</a>    <span class="k">def</span> <span class="nf">initializer_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Options for input file initializers</span>
<span class="sd">        The input initializer overwrites self.initializer </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">initializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initializer</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_init&#39;</span><span class="p">,</span> <span class="s1">&#39;simple_trend&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;patch_init&#39;</span><span class="p">,</span> <span class="s1">&#39;extrude_casts&#39;</span><span class="p">,</span> <span class="s1">&#39;obs_points&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">initializer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;initializer </span><span class="si">%s</span><span class="s1"> is not implimented </span>
<span class="s1">                                      available options are: &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">initializer</span> <span class="o">+</span>
                                      <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="p">))</span>
        <span class="n">initializers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;text_init&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_init</span><span class="p">,</span>
                        <span class="s1">&#39;simple_trend&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_trend</span><span class="p">,</span>
                        <span class="s1">&#39;patch_init&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_init</span><span class="p">,</span>
                        <span class="s1">&#39;extrude_casts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrude_casts</span><span class="p">,</span>
                        <span class="s1">&#39;obs_points&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_points</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">initializers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initializer</span><span class="p">]</span></div>

<div class="viewcode-block" id="VariableField.patch_initializer_options"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.VariableField.patch_initializer_options">[docs]</a>    <span class="k">def</span> <span class="nf">patch_initializer_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initializer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Options for patch initializers</span>
<span class="sd">        The input initializer overwrites self.initializer </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_init&#39;</span><span class="p">,</span> <span class="s1">&#39;simple_trend&#39;</span><span class="p">,</span> <span class="s1">&#39;extrude_casts&#39;</span><span class="p">,</span> <span class="s1">&#39;obs_points&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">initializer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;initializer </span><span class="si">%s</span><span class="s1"> is not implimented </span>
<span class="s1">                                      available options are: &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">initializer</span> <span class="o">+</span>
                                      <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="p">))</span>
        <span class="n">initializers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;text_init&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_init</span><span class="p">,</span>
                        <span class="s1">&#39;simple_trend&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_trend</span><span class="p">,</span>
                        <span class="s1">&#39;extrude_casts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrude_casts</span><span class="p">,</span>
                        <span class="s1">&#39;obs_points&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_points</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">initializers</span><span class="p">[</span><span class="n">initializer</span><span class="p">]</span></div>

<div class="viewcode-block" id="VariableField.GenerateField"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.VariableField.GenerateField">[docs]</a>    <span class="k">def</span> <span class="nf">GenerateField</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#initializer = globals()[self.initializer_options()]()</span>
        <span class="n">initializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initializer_options</span><span class="p">()</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">initializer</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">var</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> field has nan in it: check input data and variable name&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable_name</span><span class="p">)</span>
        <span class="n">da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_dataarray</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">da</span></div>

<div class="viewcode-block" id="VariableField.map_to_3D"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.VariableField.map_to_3D">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">map_to_3D</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v_2d</span><span class="p">,</span> <span class="n">nz</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        polulate the 2D map values to 3D by applying the uniform values over dpeth. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v_2d</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">v_2d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nz</span><span class="p">))</span></div>

<div class="viewcode-block" id="VariableField.get_value"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.VariableField.get_value">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dict_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_obj</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="VariableField.get_key"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.VariableField.get_key">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_key</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dict_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_obj</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="VariableField.elem2node_values"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.VariableField.elem2node_values">[docs]</a>    <span class="k">def</span> <span class="nf">elem2node_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vmap</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        equation converting 2D values on element to nodes. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vmap</span><span class="p">)</span>
        <span class="n">vnode</span> <span class="o">=</span> <span class="p">[</span><span class="n">vmap</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">node2elems</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">vnode</span></div>

<div class="viewcode-block" id="VariableField.node2elem_values"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.VariableField.node2elem_values">[docs]</a>    <span class="k">def</span> <span class="nf">node2elem_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vmap</span><span class="p">):</span>
        <span class="n">vmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vmap</span><span class="p">)</span>
        <span class="n">velem</span> <span class="o">=</span> <span class="p">[</span><span class="n">vmap</span><span class="p">[</span><span class="n">el</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">velem</span></div>

<div class="viewcode-block" id="VariableField.simple_trend"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.VariableField.simple_trend">[docs]</a>    <span class="k">def</span> <span class="nf">simple_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ini_meta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inpoly</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assigning a spatially uniformed value or an equation that&#39;s dependent on lat, lon</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ini_meta</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">ini_meta</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ini_meta</span><span class="p">)</span>  <span class="c1"># get variable values</span>

        <span class="k">if</span> <span class="n">inpoly</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_hgrid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inpoly</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_hgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hgrid</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="c1"># initialize the 3D field</span>
            <span class="n">v_ini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_hgrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_vgrid</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">v_ini</span> <span class="o">+</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">inpoly</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hgrid</span><span class="p">[</span><span class="n">inpoly</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hgrid</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;SED3D_bed&#39;</span><span class="p">,</span> <span class="s1">&#39;SED3D_bedfrac&#39;</span><span class="p">]:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">v_ini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_hgrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_vgrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sdim</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)):</span>
                    <span class="n">v_ini</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">v_ini</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># x and y based function where x and y are lat and lon.</span>
                <span class="n">vmap</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;2D&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">centering</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">vmap</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_to_3D</span><span class="p">(</span><span class="n">vmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_vgrid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span><span class="p">(</span><span class="s2">&quot;input value not recognised as float, int, or str&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="VariableField.text_init"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.VariableField.text_init">[docs]</a>    <span class="k">def</span> <span class="nf">text_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ini_meta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inpoly</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reading 2D map from either a .prop (on element) or a .ic (on node) file </span>
<span class="sd">        If a prop file is read, the element values will need to be converted to node values. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ini_meta</span><span class="p">:</span>
            <span class="n">text_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">ini_meta</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ini_meta</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text_fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.ic&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">centering</span> <span class="o">==</span> <span class="s1">&#39;node&#39;</span><span class="p">:</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="n">SchismMeshGr3Reader</span><span class="p">()</span>  <span class="c1"># the ic file has the same format as the .gr3 file</span>
                <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fpath_mesh</span><span class="o">=</span><span class="n">text_fn</span><span class="p">)</span>
                <span class="n">icmesh</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fpath_mesh</span><span class="o">=</span><span class="n">text_fn</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">icmesh</span><span class="o">.</span><span class="n">n_nodes</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_nodes</span><span class="p">:</span>
                    <span class="n">vmap</span> <span class="o">=</span> <span class="n">icmesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;The node of </span><span class="si">%s</span><span class="s2"> is incompatible with the grid node in hgrid.gr3&quot;</span> <span class="o">%</span> <span class="n">text_fn</span><span class="p">)</span>

                <span class="c1"># if the required input is on element, but values on nodes are provided.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vmap</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hgrid</span><span class="p">:</span>
                    <span class="n">vmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node2elem_values</span><span class="p">(</span><span class="n">vmap</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> gives value on node, but value on </span><span class="si">%s</span><span class="s1"> is required&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">text_fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">centering</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">text_fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.prop&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">centering</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">,</span> <span class="s1">&#39;prism&#39;</span><span class="p">]:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">text_fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="n">vmap</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vmap</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_elems</span><span class="p">:</span>
                    <span class="k">raise</span><span class="p">(</span>
                        <span class="s2">&quot;The element of </span><span class="si">%s</span><span class="s2"> is incompatible with grid element in hgrid.gr3&quot;</span> <span class="o">%</span> <span class="n">text_fn</span><span class="p">)</span>
                <span class="c1"># if the required input is on nodes, but values on elements are provided</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vmap</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hgrid</span><span class="p">:</span>
                    <span class="n">vmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elem2node_values</span><span class="p">(</span><span class="n">vmap</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> gives value on element, but value on </span><span class="si">%s</span><span class="s1"> is required&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">text_fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">centering</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">text_fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">):</span>
            <span class="n">ncdata</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">text_fn</span><span class="p">)</span>
            <span class="n">vmap</span> <span class="o">=</span> <span class="n">ncdata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">vdim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">vmap</span><span class="p">)</span>
            <span class="n">nh</span> <span class="o">=</span> <span class="n">vdim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># horizontal grid dimension of the input nc file.</span>
            <span class="k">if</span> <span class="n">nh</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hgrid</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hgrid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_nodes</span><span class="p">:</span>
                    <span class="n">vmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elem2node_values</span><span class="p">(</span><span class="n">vmap</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hgrid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_elems</span><span class="p">:</span>
                    <span class="n">vmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node2elem_values</span><span class="p">(</span><span class="n">vmap</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;The horizontal dim of </span><span class="si">%f</span><span class="s2"> does not match with the mesh grid&quot;</span> <span class="o">%</span> <span class="n">text_fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Only .ic, .prop, or .nc are allowed as text input&quot;</span><span class="p">)</span>

        <span class="n">vmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">vmap</span><span class="p">)</span>
        <span class="n">vdim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">vmap</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vdim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># 1D array</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">centering</span> <span class="o">==</span> <span class="s1">&#39;node2D&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">vmap</span><span class="p">[</span><span class="n">inpoly</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_to_3D</span><span class="p">(</span><span class="n">vmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_vgrid</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">inpoly</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">vdim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># 2D array</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;SED3D_bed&#39;</span><span class="p">,</span> <span class="s1">&#39;SED3D_bedfrac&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">vmap</span><span class="p">[</span><span class="n">inpoly</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_to_3D</span><span class="p">(</span><span class="n">vmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_vgrid</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">inpoly</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># if alrady 3D array</span>
            <span class="k">return</span> <span class="n">vmap</span><span class="p">[</span><span class="n">inpoly</span><span class="p">]</span></div>

<div class="viewcode-block" id="VariableField.patch_init"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.VariableField.patch_init">[docs]</a>    <span class="k">def</span> <span class="nf">patch_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poly_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># regional based initializer</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">poly_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ini_meta</span><span class="p">[</span><span class="s1">&#39;regions_fn&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">poly_fn</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">EOFError</span><span class="p">(</span>
                    <span class="s2">&quot;regional polygon file is needed for pathch_ini implementation&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">poly_fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;shp&#39;</span><span class="p">):</span>
            <span class="c1"># perform contiguity check and return a mapping array if successful.</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="n">geo_tools</span><span class="o">.</span><span class="n">Contiguity_Check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">poly_fn</span><span class="p">,</span>
                                                 <span class="n">proj4</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">proj4</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Poly_fn can only be shapefile&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ini_meta</span><span class="p">[</span><span class="s1">&#39;smoothing&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Smoothing not implemented yet&quot;</span><span class="p">)</span>

        <span class="n">v_merge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_hgrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_vgrid</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ini_meta</span><span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">]):</span>
            <span class="n">ini_meta</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;initializer&#39;</span><span class="p">]</span>
            <span class="n">initializer_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">ini_meta</span><span class="p">)</span>
            <span class="n">initializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_initializer_options</span><span class="p">(</span><span class="n">initializer_key</span><span class="p">)</span>
            <span class="n">ini_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">ini_meta</span><span class="p">)</span>
            <span class="n">inpoly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mapping</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># mapping is one-based.</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">initializer</span><span class="p">(</span><span class="n">ini_meta</span><span class="p">,</span> <span class="n">inpoly</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;region </span><span class="si">%f</span><span class="s2"> has nan in </span><span class="si">%s</span><span class="s2"> field&quot;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable_name</span><span class="p">))</span>
            <span class="n">v_merge</span><span class="p">[</span><span class="n">inpoly</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v_merge</span></div>

    <span class="c1"># USGS cast (2D observational points)</span>
<div class="viewcode-block" id="VariableField.extrude_casts"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.VariableField.extrude_casts">[docs]</a>    <span class="k">def</span> <span class="nf">extrude_casts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ini_meta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inpoly</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ini_meta</span><span class="p">:</span>
            <span class="n">ini_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ini_meta</span>
        <span class="n">station_fn</span> <span class="o">=</span> <span class="n">ini_meta</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span>
        <span class="n">data_fn</span> <span class="o">=</span> <span class="n">ini_meta</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">variable</span> <span class="o">=</span> <span class="n">ini_meta</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

        <span class="n">polaris_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_fn</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># find the nearest date for the cruise</span>
        <span class="n">polaris_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">polaris_data</span><span class="o">.</span><span class="n">Date</span><span class="p">)</span>
        <span class="n">polaris_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">polaris_data</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">cast_date</span> <span class="o">=</span> <span class="n">polaris_date</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">polaris_date</span><span class="o">-</span><span class="n">date</span><span class="p">))]</span>
        <span class="k">if</span> <span class="s1">&#39;Station&#39;</span> <span class="ow">in</span> <span class="n">polaris_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">polaris_cast</span> <span class="o">=</span> <span class="n">polaris_data</span><span class="p">[</span><span class="n">polaris_data</span><span class="o">.</span><span class="n">datetime</span> <span class="o">==</span> <span class="n">cast_date</span><span class="p">][[</span>
                <span class="s1">&#39;Station&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="s1">&#39;Depth&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">polaris_cast</span> <span class="o">=</span> <span class="n">polaris_data</span><span class="p">[</span><span class="n">polaris_data</span><span class="o">.</span><span class="n">datetime</span> <span class="o">==</span> <span class="n">cast_date</span><span class="p">][[</span>
                <span class="s1">&#39;Station Number&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="s1">&#39;Depth&#39;</span><span class="p">]]</span>
            <span class="n">polaris_cast</span><span class="p">[</span><span class="s1">&#39;Station&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">polaris_cast</span><span class="p">[</span><span class="s1">&#39;Station Number&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="nb">int</span><span class="p">)</span>
        <span class="n">polaris_cast</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Station&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">polaris_cast</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="c1"># change column to lower case</span>
            <span class="n">polaris_cast</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">polaris_cast</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">indnan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">polaris_cast</span><span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">lower</span><span class="p">()]))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indnan</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">polaris_cast</span> <span class="o">=</span> <span class="n">polaris_cast</span><span class="p">[</span><span class="o">~</span><span class="n">indnan</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;The variable </span><span class="si">%s</span><span class="s2"> is not in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">data_fn</span><span class="p">))</span>

        <span class="c1"># find the corresponding station locations</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">station_fn</span><span class="p">)[</span>
            <span class="p">[</span><span class="s1">&#39;Station&#39;</span><span class="p">,</span> <span class="s1">&#39;North_Lati&#39;</span><span class="p">,</span> <span class="s1">&#39;West_Longi&#39;</span><span class="p">]]</span>
        <span class="n">stations</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Station&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">polaris_cast</span> <span class="o">=</span> <span class="n">polaris_cast</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Station&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inpoly</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_hgrid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inpoly</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_hgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hgrid</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_hgrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_vgrid</span><span class="p">))</span>

        <span class="c1"># partition the grid domain by polaris stations based on horizontal distance</span>
        <span class="n">grid_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({})</span>
        <span class="n">g_xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hgrid</span><span class="p">[</span><span class="n">inpoly</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj4</span> <span class="o">==</span> <span class="s1">&#39;EPSG:32610&#39;</span><span class="p">:</span> <span class="c1"># utm 10N </span>
            <span class="n">g_xy</span> <span class="o">=</span> <span class="n">geo_tools</span><span class="o">.</span><span class="n">utm2ll</span><span class="p">(</span><span class="n">g_xy</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># conver to (lon, lat).  </span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">polaris_cast</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">s_xy</span> <span class="o">=</span> <span class="p">[</span><span class="n">stations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">West_Longi</span><span class="p">,</span> <span class="n">stations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">North_Lati</span><span class="p">]</span>
            <span class="n">grid_df</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">cdist</span><span class="p">([</span><span class="n">s_xy</span><span class="p">],</span> <span class="n">g_xy</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">grid_df</span><span class="p">[</span><span class="s1">&#39;nearest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">idxmin</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># loop through each station and perform vertical interpolations for the nearest grid</span>
        <span class="c1"># the depths computed are negative but polaris depths are positive</span>
        <span class="n">grid_depths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vgrid</span><span class="p">[</span><span class="n">inpoly</span><span class="p">,</span> <span class="p">:]</span><span class="o">*-</span><span class="mf">1.0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">polaris_cast</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">grid_nearest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">grid_df</span><span class="o">.</span><span class="n">nearest</span> <span class="o">==</span> <span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">zc</span> <span class="o">=</span> <span class="n">polaris_cast</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
                <span class="n">zc</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="n">zc</span><span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">lower</span><span class="p">()],</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;previous&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grid_nearest</span><span class="p">:</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="n">grid_depths</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
                <span class="n">v</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The interpolated </span><span class="si">%s</span><span class="s2"> field has nan in it&quot;</span> <span class="o">%</span> <span class="n">variable</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span></div>

<span class="c1">#    def extrude_casts(self,ini_meta=None,inpoly=None): # USGS cast (2D observational points)</span>
<span class="c1">#        if not ini_meta:</span>
<span class="c1">#            ini_meta = self.ini_meta</span>
<span class="c1">#        station_fn = ini_meta[&#39;station&#39;]</span>
<span class="c1">#        data_fn = ini_meta[&#39;data&#39;]</span>
<span class="c1">#        variable = ini_meta[&#39;variable&#39;]</span>
<span class="c1">#        date = pd.to_datetime(self.date)</span>
<span class="c1">#        polaris_data = pd.read_csv(data_fn,skiprows=[1])</span>
<span class="c1">#        # find the nearest date for the cruise</span>
<span class="c1">#        polaris_data[&#39;datetime&#39;] = pd.to_datetime(polaris_data.Date)</span>
<span class="c1">#        polaris_date = pd.to_datetime(polaris_data.Date.unique())</span>
<span class="c1">#        cast_date = polaris_date[np.argmin(abs(polaris_date-date))]</span>
<span class="c1">#        polaris_cast = polaris_data[polaris_data.datetime == cast_date][[&#39;Station Number&#39;,variable,&#39;Depth&#39;]]</span>
<span class="c1">#        polaris_cast[&#39;Station&#39;] = polaris_cast[&#39;Station Number&#39;].astype(int)</span>
<span class="c1">#        polaris_cast.set_index(&#39;Station&#39;,inplace=True)</span>
<span class="c1">#        if variable.lower() in polaris_cast.columns.str.lower():</span>
<span class="c1">#            polaris_cast.columns = map(str.lower,polaris_cast.columns) # change column to lower case</span>
<span class="c1">#            indnan = np.where(np.isnan(polaris_cast[variable.lower()]))[0]</span>
<span class="c1">#            if len(indnan)&gt;0:</span>
<span class="c1">#                polaris_cast = polaris_cast[~indnan]</span>
<span class="c1">#        else:</span>
<span class="c1">#            raise IndexError(&quot;The variable %s is not in %s&quot;%(variable,data_fn))</span>
<span class="c1">#</span>
<span class="c1">#        # find the corresponding station locations</span>
<span class="c1">#        stations = pd.read_csv(station_fn)[[&#39;Station&#39;,&#39;North_Lati&#39;,&#39;West_Longi&#39;]]</span>
<span class="c1">#        stations.set_index(&#39;Station&#39;,inplace=True)</span>
<span class="c1">#        polaris_cast = polaris_cast.join(stations,on=&#39;Station&#39;,how=&#39;left&#39;)</span>
<span class="c1">#        polaris_cast[&#39;Point&#39;] = [Point(x,y) for x,y in zip(polaris_cast.West_Longi,polaris_cast.North_Lati)]</span>
<span class="c1">#        multi_points = MultiPoint(polaris_cast[&#39;Point&#39;].values)</span>
<span class="c1">#</span>
<span class="c1">#        # loop through all cells</span>
<span class="c1">#        if inpoly is not None:</span>
<span class="c1">#            n_hgrid = len(inpoly)</span>
<span class="c1">#        else:</span>
<span class="c1">#            n_hgrid = self.n_hgrid</span>
<span class="c1">#        v = np.zeros((n_hgrid,self.n_vgrid))</span>
<span class="c1">#        for i, xy in enumerate(self.hgrid[inpoly]):</span>
<span class="c1">#            x = xy[0]</span>
<span class="c1">#            y = xy[1]</span>
<span class="c1">#            p = Point((x,y))</span>
<span class="c1">#            zc = polaris_cast.iloc[np.where(polaris_cast.Point ==</span>
<span class="c1">#                                       nearest_points(p,multi_points)[1])[0]][[variable.lower(),&#39;depth&#39;]]</span>
<span class="c1">#            depths = self.vgrid[i,:]*-1.0 # the depths computed are negative but polaris depths are positive</span>
<span class="c1">#            # interp- and extrapolate over depths.</span>
<span class="c1">#            f = interpolate.interp1d(zc.depth,zc[variable.lower()],fill_value=&#39;extrapolate&#39;,kind=&#39;previous&#39;)</span>
<span class="c1">#            v[i,:] = f(depths)</span>
<span class="c1">#            if np.any(np.isnan(v)):</span>
<span class="c1">#                raise ValueError(&quot;The interpolated %s field has nan in it&quot;%variable)</span>
<span class="c1">#        return v</span>

<div class="viewcode-block" id="VariableField.obs_points"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.VariableField.obs_points">[docs]</a>    <span class="k">def</span> <span class="nf">obs_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ini_meta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inpoly</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># 1D observational points</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        obs_file includes Lat, Lon, and values for the variable. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Interp2D</span>  <span class="c1"># now onl 2D interpolation IDW is implemented.</span>
        <span class="k">if</span> <span class="n">ini_meta</span><span class="p">:</span>
            <span class="n">obs_file</span> <span class="o">=</span> <span class="n">ini_meta</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">ini_meta</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obs_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ini_meta</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ini_meta</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
        <span class="n">obs_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">obs_file</span><span class="p">)</span>
        <span class="n">obs_loc</span> <span class="o">=</span> <span class="n">obs_data</span><span class="p">[[</span><span class="s1">&#39;Lon&#39;</span><span class="p">,</span> <span class="s1">&#39;Lat&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">invdisttree</span> <span class="o">=</span> <span class="n">Interp2D</span><span class="o">.</span><span class="n">Invdisttree</span><span class="p">(</span><span class="n">obs_loc</span><span class="p">,</span> <span class="n">obs_data</span><span class="p">[</span><span class="n">variable</span><span class="p">],</span>
                                           <span class="n">leafsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inpoly</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node_xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hgrid</span><span class="p">[</span><span class="n">inpoly</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node_xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hgrid</span>
        <span class="n">vmap</span> <span class="o">=</span> <span class="n">invdisttree</span><span class="p">(</span><span class="n">node_xy</span><span class="p">,</span> <span class="n">nnear</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vmap</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;vmap has nan value in it.Check </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obs_file</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_to_3D</span><span class="p">(</span><span class="n">vmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_vgrid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span></div>

<div class="viewcode-block" id="VariableField.create_dataarray"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.VariableField.create_dataarray">[docs]</a>    <span class="k">def</span> <span class="nf">create_dataarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="c1"># for prism (tracer variables), tr_el and tr_nd0 need to be calculated.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">centering</span> <span class="o">==</span> <span class="s1">&#39;prism&#39;</span><span class="p">:</span>
            <span class="c1"># convert from node to element values for tracers</span>
            <span class="c1"># first average to the node center horizontally</span>
            <span class="n">var_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node2elem_values</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="n">var_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">var_temp</span><span class="p">)</span>
            <span class="n">var_el</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_elems</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_vert_levels</span><span class="p">))</span>
            <span class="c1"># then average to the element center vertically</span>
            <span class="n">var_el</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">var_temp</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">var_temp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.0</span>
            <span class="n">var_el</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_el</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># add one dummy layer.</span>

            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable_name</span>

            <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_nd&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="s1">&#39;nVert&#39;</span><span class="p">],</span> <span class="n">var</span><span class="p">),</span>
                             <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_nd0&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="s1">&#39;nVert&#39;</span><span class="p">],</span> <span class="n">var</span><span class="p">),</span>
                             <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_el&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;elem&#39;</span><span class="p">,</span> <span class="s1">&#39;nVert&#39;</span><span class="p">],</span> <span class="n">var_el</span><span class="p">)})</span>
            <span class="c1"># coords={&#39;elem&#39;:range(self.n_elems),</span>
            <span class="c1"># &#39;node&#39;:range(self.n_nodes),</span>
            <span class="c1"># &#39;nVert&#39;:range(self.n_vert_levels)})</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">centering</span> <span class="o">==</span> <span class="s1">&#39;node2D&#39;</span><span class="p">:</span>
            <span class="n">ds_var</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">var</span><span class="p">),</span>  <span class="c1"># coords=[range(self.n_hgrid)],</span>
                                  <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hgrid_name</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_name</span><span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds_var</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">centering</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bed&#39;</span><span class="p">,</span> <span class="s1">&#39;bedfrac&#39;</span><span class="p">]:</span>
            <span class="n">ds_var</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">var</span><span class="p">,</span>  <span class="c1"># coords=[range(self.n_hgrid),range(self.n_vgrid),range(self.n_sdim)],</span>
                                  <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hgrid_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vgrid_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim_name</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_name</span><span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds_var</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ds_var</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">var</span><span class="p">,</span>  <span class="c1"># coords=[range(self.n_hgrid),range(self.n_vgrid)],</span>
                                  <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hgrid_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vgrid_name</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_name</span><span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds_var</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ds</span></div></div>


<div class="viewcode-block" id="read_param_in"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.read_param_in">[docs]</a><span class="k">def</span> <span class="nf">read_param_in</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    read param.in file and generate a dict object with key, value pairs for all the parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">param</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># only take the portion of the arguement before the comment</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="ow">or</span> 
                <span class="ow">not</span> <span class="n">line</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;==&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>  <span class="c1"># try converting to numerics.</span>
                    <span class="n">param</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">num</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># if it&#39;s only string</span>
                    <span class="n">param</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">param</span></div>


<div class="viewcode-block" id="num"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.num">[docs]</a><span class="k">def</span> <span class="nf">num</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>


<div class="viewcode-block" id="n_tracers"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.n_tracers">[docs]</a><span class="k">def</span> <span class="nf">n_tracers</span><span class="p">(</span><span class="n">param_in</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;TEM&#39;</span><span class="p">,</span> <span class="s1">&#39;SAL&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot; return the number of tracers, the sequence of the tracers and a list </span>
<span class="sd">    of tracer names based on the input list of modules and corresponding </span>
<span class="sd">    input files. </span>
<span class="sd">    Availabel modules are:</span>
<span class="sd">!     1: T (default)</span>
<span class="sd">!     2: S (default)</span>
<span class="sd">!     3: GEN</span>
<span class="sd">!     4: AGE</span>
<span class="sd">!     5: SED3D: SED</span>
<span class="sd">!     6: EcoSim: ECO</span>
<span class="sd">!     7: ICM: ICM and/or ICM_PH</span>
<span class="sd">!     8: CoSINE: COSINE</span>
<span class="sd">!     9: Feco: FIB</span>
<span class="sd">!    10: TIMOR</span>
<span class="sd">!    11: FABM    </span>
<span class="sd">    The script is mainly translated from schism_ini.F90    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ntrs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># number of tracers for each module</span>
    <span class="n">tr_mname</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># tracer moodule name</span>
    <span class="n">irange_tr_1</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># the starting indices for each module</span>
    <span class="n">irange_tr_2</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># the ending indices for each module</span>

    <span class="n">tr_mname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;TEM&#39;</span><span class="p">)</span>
    <span class="n">irange_tr_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># start index</span>
    <span class="n">ntrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># temperature tracer</span>
    <span class="n">irange_tr_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># end index</span>

    <span class="n">tr_mname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;SAL&#39;</span><span class="p">)</span>
    <span class="n">irange_tr_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>
    <span class="n">ntrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># T,S counted as separate model</span>
    <span class="n">irange_tr_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>

    <span class="n">param</span> <span class="o">=</span> <span class="n">read_param_in</span><span class="p">(</span><span class="n">param_in</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;GEN&quot;</span> <span class="ow">in</span> <span class="n">modules</span> <span class="ow">and</span> <span class="s1">&#39;ntracer_gen&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">irange_tr_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>
        <span class="n">ntrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;ntracer_gen&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">tr_mname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;GEN_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">irange_tr_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>

    <span class="k">if</span> <span class="s2">&quot;AGE&quot;</span> <span class="ow">in</span> <span class="n">modules</span> <span class="ow">and</span> <span class="s1">&#39;ntracer_age&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">irange_tr_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>
        <span class="n">ntrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;ntracer_age&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">tr_mname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;AGE_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">irange_tr_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>

    <span class="k">if</span> <span class="s2">&quot;SED&quot;</span> <span class="ow">in</span> <span class="n">modules</span> <span class="ow">and</span> <span class="s1">&#39;sed_class&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">irange_tr_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>
        <span class="c1"># sediment concentration for different classes (g/m3??)</span>
        <span class="n">ntrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;sed_class&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">tr_mname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;SED_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">irange_tr_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>

    <span class="k">if</span> <span class="s2">&quot;ECO&quot;</span> <span class="ow">in</span> <span class="n">modules</span> <span class="ow">and</span> <span class="s1">&#39;eco_class&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Initiating ECO from hotstart.nc may not have been implemented&quot;</span><span class="p">)</span>
        <span class="n">irange_tr_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>
        <span class="n">ntrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;eco_class&#39;</span><span class="p">])</span>
        <span class="n">tr_mname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ECO&#39;</span><span class="p">)</span>
        <span class="n">irange_tr_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>

    <span class="k">if</span> <span class="s2">&quot;ICM&quot;</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
        <span class="n">irange_tr_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>
        <span class="n">ICM_name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ZB1&#39;</span><span class="p">,</span> <span class="s1">&#39;ZB2&#39;</span><span class="p">,</span> <span class="s1">&#39;PB1&#39;</span><span class="p">,</span> <span class="s1">&#39;PB2&#39;</span><span class="p">,</span> <span class="s1">&#39;PB3&#39;</span><span class="p">,</span> <span class="s1">&#39;RPOC&#39;</span><span class="p">,</span> <span class="s1">&#39;LPOC&#39;</span><span class="p">,</span> <span class="s1">&#39;DOC&#39;</span><span class="p">,</span> <span class="s1">&#39;RPON&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;LPON&#39;</span><span class="p">,</span> <span class="s1">&#39;DON&#39;</span><span class="p">,</span> <span class="s1">&#39;NH4&#39;</span><span class="p">,</span> <span class="s1">&#39;NO3&#39;</span><span class="p">,</span> <span class="s1">&#39;RPOP&#39;</span><span class="p">,</span> <span class="s1">&#39;LPOP&#39;</span><span class="p">,</span> <span class="s1">&#39;DOP&#39;</span><span class="p">,</span> <span class="s1">&#39;PO4t&#39;</span><span class="p">,</span> <span class="s1">&#39;SU&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;SAT&#39;</span><span class="p">,</span> <span class="s1">&#39;COD&#39;</span><span class="p">,</span> <span class="s1">&#39;DOO&#39;</span><span class="p">,</span> <span class="s1">&#39;TIC&#39;</span><span class="p">,</span> <span class="s1">&#39;ALK&#39;</span><span class="p">,</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;CACO3&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;ICM_PH&quot;</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
            <span class="n">ntrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ICM_name</span><span class="p">:</span>
                <span class="n">tr_mname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ICM_</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ntrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ICM_name</span><span class="p">[:</span><span class="mi">21</span><span class="p">]:</span>
                <span class="n">tr_mname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ICM_</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="c1"># The notation for the names can be found in icm.F90.</span>
        <span class="n">irange_tr_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>

    <span class="k">if</span> <span class="s2">&quot;COSINE&quot;</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
        <span class="n">irange_tr_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>
        <span class="n">ntrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">COS_name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NO3&#39;</span><span class="p">,</span> <span class="s1">&#39;SiO4&#39;</span><span class="p">,</span> <span class="s1">&#39;NH4&#39;</span><span class="p">,</span> <span class="s1">&#39;S1&#39;</span><span class="p">,</span> <span class="s1">&#39;S2&#39;</span><span class="p">,</span> <span class="s1">&#39;Z1&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Z2&#39;</span><span class="p">,</span> <span class="s1">&#39;DN&#39;</span><span class="p">,</span> <span class="s1">&#39;DSi&#39;</span><span class="p">,</span> <span class="s1">&#39;PO4&#39;</span><span class="p">,</span> <span class="s1">&#39;DOX&#39;</span><span class="p">,</span> <span class="s1">&#39;CO2&#39;</span><span class="p">,</span> <span class="s1">&#39;ALK&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">COS_name</span><span class="p">:</span>
            <span class="n">tr_mname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;COS_</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">irange_tr_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>

    <span class="k">if</span> <span class="s2">&quot;FIB&quot;</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>  <span class="c1"># Fecal Indicator Bacteria model</span>
        <span class="c1"># It appears that FIB has to be read from gr3 files.</span>
        <span class="n">irange_tr_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>
        <span class="n">ntrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">FIB_name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F_coli&#39;</span><span class="p">,</span> <span class="s1">&#39;E_coli&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">FIB_name</span><span class="p">:</span>
            <span class="n">tr_mname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;FIB_%&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">irange_tr_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>

<span class="c1">#    if &quot;TIMOR&quot; in modules:</span>
<span class="c1">#        tr_mname.append(&#39;TMR&#39;)</span>

    <span class="k">if</span> <span class="s2">&quot;FABM&quot;</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Initializing FABM from hotstart.nc is currently not implemented; </span><span class="se">\</span>
<span class="s2">                                  but FABM can be initialized by &#39;fabm_schism_hotstart.nc. </span><span class="se">\</span>
<span class="s2">                                  see schism_init.F90 for details&quot;</span><span class="p">)</span>
        <span class="n">irange_tr_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>
        <span class="n">tr_mname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;FBM&#39;</span><span class="p">)</span>
        <span class="n">irange_tr_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">))</span>

    <span class="n">irange_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">irange_tr_1</span><span class="p">,</span> <span class="n">irange_tr_2</span><span class="p">])</span>

    <span class="c1"># Total # of tracers (including T,S)</span>
    <span class="n">ntracers</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ntrs</span><span class="p">)</span>  <span class="c1"># including T,S</span>

    <span class="k">return</span> <span class="n">ntracers</span><span class="p">,</span> <span class="n">ntrs</span><span class="p">,</span> <span class="n">irange_tr</span><span class="p">,</span> <span class="n">tr_mname</span></div>


<div class="viewcode-block" id="hotstart_to_outputnc"><a class="viewcode-back" href="../../schimpy.html#schimpy.schism_hotstart.hotstart_to_outputnc">[docs]</a><span class="k">def</span> <span class="nf">hotstart_to_outputnc</span><span class="p">(</span><span class="n">hotstart_fn</span><span class="p">,</span> <span class="n">init_date</span><span class="p">,</span> <span class="n">hgrid_fn</span><span class="o">=</span><span class="s1">&#39;hgrid.gr3&#39;</span><span class="p">,</span> 
                         <span class="n">vgrid_fn</span><span class="o">=</span><span class="s1">&#39;vgrid.in&#39;</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="s2">&quot;hotstart_out.nc&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convert hotstart.nc to schism output nc file format that can be read by VisIt. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># load hotstart file and grid file</span>
    <span class="n">hnc</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">hotstart_fn</span><span class="p">)</span>

    <span class="c1"># rename from hotstart dim name to output dim name</span>
    <span class="n">newname</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;node&#39;</span><span class="p">:</span> <span class="s1">&#39;nSCHISM_hgrid_node&#39;</span><span class="p">,</span>
               <span class="s1">&#39;elem&#39;</span><span class="p">:</span> <span class="s1">&#39;nSCHISM_hgrid_face&#39;</span><span class="p">,</span>
               <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;nSCHISM_hgrid_edge&#39;</span><span class="p">,</span>
               <span class="s1">&#39;nVert&#39;</span><span class="p">:</span> <span class="s1">&#39;nSCHISM_vgrid_layers&#39;</span><span class="p">,</span>
               <span class="s1">&#39;idry&#39;</span><span class="p">:</span> <span class="s1">&#39;wetdry_node&#39;</span><span class="p">,</span>
               <span class="s1">&#39;idry_e&#39;</span><span class="p">:</span> <span class="s1">&#39;wetdry_elem&#39;</span><span class="p">}</span>
    <span class="n">hnc</span> <span class="o">=</span> <span class="n">hnc</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">newname</span><span class="p">)</span>

    <span class="n">grid_newname</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n_hgrid_face&#39;</span><span class="p">:</span> <span class="s1">&#39;nSCHISM_hgrid_face&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;n_face_node&#39;</span><span class="p">:</span> <span class="s1">&#39;nMaxSCHISM_hgrid_face_nodes&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;n_hgrid_edge&#39;</span><span class="p">:</span> <span class="s1">&#39;nSCHISM_hgrid_edge&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;n_hgrid_node&#39;</span><span class="p">:</span> <span class="s1">&#39;nSCHISM_hgrid_node&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;hgrid_face_nodes&#39;</span><span class="p">:</span> <span class="s1">&#39;SCHISM_hgrid_face_nodes&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;hgrid_edge_nodes&#39;</span><span class="p">:</span> <span class="s1">&#39;SCHISM_hgrid_edge_nodes&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;hgrid_node_x&#39;</span><span class="p">:</span> <span class="s1">&#39;SCHISM_hgrid_node_x&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;hgrid_node_y&#39;</span><span class="p">:</span> <span class="s1">&#39;SCHISM_hgrid_node_y&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;hgrid_face_x&#39;</span><span class="p">:</span> <span class="s1">&#39;SCHISM_hgrid_face_x&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;hgrid_face_y&#39;</span><span class="p">:</span> <span class="s1">&#39;SCHISM_hgrid_face_y&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;hgrid_edge_x&#39;</span><span class="p">:</span> <span class="s1">&#39;SCHISM_hgrid_edge_x&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;hgrid_edge_y&#39;</span><span class="p">:</span> <span class="s1">&#39;SCHISM_hgrid_edge_y&#39;</span><span class="p">}</span>
    <span class="c1"># &#39;n_vgrid_layers&#39;:&#39;nSCHISM_vgrid_layers&#39;}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;hgrid.nc&quot;</span><span class="p">):</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">read_mesh</span><span class="p">(</span><span class="n">hgrid_fn</span><span class="p">,</span> <span class="n">vgrid_fn</span><span class="p">)</span>
        <span class="n">write_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;hgrid.nc&#39;</span><span class="p">)</span>
    <span class="n">hgrid_nc</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s2">&quot;hgrid.nc&quot;</span><span class="p">)</span>
    <span class="n">hgrid_nc</span> <span class="o">=</span> <span class="n">hgrid_nc</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">grid_newname</span><span class="p">)</span>

    <span class="c1"># Change lat lon to utm-x, y (VisIt only accepts projected coordinates)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="s1">&#39;face&#39;</span><span class="p">,</span> <span class="s1">&#39;node&#39;</span><span class="p">]:</span>
        <span class="n">utm_data</span> <span class="o">=</span> <span class="n">geo_tools</span><span class="o">.</span><span class="n">ll2utm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">hgrid_nc</span><span class="p">[</span><span class="s1">&#39;SCHISM_hgrid_</span><span class="si">%s</span><span class="s1">_x&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                <span class="n">hgrid_nc</span><span class="p">[</span><span class="s1">&#39;SCHISM_hgrid_</span><span class="si">%s</span><span class="s1">_y&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]))</span>
        <span class="n">gx</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">utm_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="n">hgrid_nc</span><span class="p">[</span><span class="s1">&#39;SCHISM_hgrid_</span><span class="si">%s</span><span class="s1">_x&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        <span class="n">gx</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">hgrid_nc</span><span class="p">[</span><span class="s1">&#39;SCHISM_hgrid_</span><span class="si">%s</span><span class="s1">_x&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
        <span class="n">gx</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;standard_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;projection_x_coordinate&#39;</span>
        <span class="n">gx</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>

        <span class="n">gy</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">utm_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="n">hgrid_nc</span><span class="p">[</span><span class="s1">&#39;SCHISM_hgrid_</span><span class="si">%s</span><span class="s1">_y&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        <span class="n">gy</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">hgrid_nc</span><span class="p">[</span><span class="s1">&#39;SCHISM_hgrid_</span><span class="si">%s</span><span class="s1">_y&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
        <span class="n">gy</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;standard_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;projection_y_coordinate&#39;</span>
        <span class="n">gy</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>

        <span class="c1"># update the values</span>
        <span class="n">hgrid_nc</span><span class="p">[</span><span class="s1">&#39;SCHISM_hgrid_</span><span class="si">%s</span><span class="s1">_x&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">gx</span>
        <span class="n">hgrid_nc</span><span class="p">[</span><span class="s1">&#39;SCHISM_hgrid_</span><span class="si">%s</span><span class="s1">_y&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">gy</span>

    <span class="c1"># add time dimension to all variable elements</span>
    <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">init_date</span><span class="p">)]</span>

    <span class="c1"># if &#39;time&#39; variable already in hnc, drop it.</span>
    <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">hnc</span><span class="o">.</span><span class="n">variables</span><span class="p">):</span>
        <span class="n">hnc</span> <span class="o">=</span> <span class="n">hnc</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

    <span class="c1"># add zcor and time dimension</span>
    <span class="c1"># zcor is positive upwards: all wet node values are negative.</span>
    <span class="n">zcor</span> <span class="o">=</span> <span class="n">hnc</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">hgrid_nc</span><span class="p">[</span><span class="s1">&#39;zcor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">zcor</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;nSCHISM_hgrid_node&#39;</span><span class="p">,</span> <span class="s1">&#39;nSCHISM_vgrid_layers&#39;</span><span class="p">])</span>
    <span class="n">hgrid_nc</span><span class="o">.</span><span class="n">zcor</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;mesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SCHISM_hgrid&#39;</span>
    <span class="n">hgrid_nc</span><span class="o">.</span><span class="n">zcor</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_horizontal_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;node&#39;</span>
    <span class="n">hgrid_nc</span><span class="o">.</span><span class="n">zcor</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_vertical_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;full&#39;</span>
    <span class="n">hgrid_nc</span><span class="o">.</span><span class="n">zcor</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;i23d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hgrid_nc</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">i23d</span>
    <span class="n">hgrid_nc</span><span class="o">.</span><span class="n">zcor</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ivs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hgrid_nc</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">ivs</span>
    <span class="n">hgrid_nc</span><span class="o">.</span><span class="n">zcor</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;missing_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">hgrid_nc</span> <span class="o">=</span> <span class="n">hgrid_nc</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>

    <span class="c1"># replace tr_nd by the actual variable name.</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hnc</span><span class="p">[</span><span class="s1">&#39;tracer_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
        <span class="n">v_values</span> <span class="o">=</span> <span class="n">hnc</span><span class="o">.</span><span class="n">tr_nd</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">ntracers</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">ds_v</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">v_values</span><span class="p">,</span>  <span class="c1"># coords=[time,n_face,n_vert],</span>
                            <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;nSCHISM_hgrid_node&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;nSCHISM_vgrid_layers&#39;</span><span class="p">],</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">v</span><span class="o">+</span><span class="s1">&#39;_nd&#39;</span><span class="p">)</span>
        <span class="n">ds_v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;mesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SCHISM_hgrid&quot;</span>
        <span class="n">ds_v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_horizontal_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;node&quot;</span>
        <span class="n">ds_v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_vertical_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span>
        <span class="n">ds_v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;i23d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># full level on node</span>
        <span class="n">ds_v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ivs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hgrid_nc</span><span class="o">.</span><span class="n">zcor</span><span class="o">.</span><span class="n">ivs</span>
        <span class="n">hnc</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">hnc</span><span class="p">,</span> <span class="n">ds_v</span><span class="p">])</span>

    <span class="c1"># replace tr_el by the actual variable name.</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hnc</span><span class="p">[</span><span class="s1">&#39;tracer_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
        <span class="n">v_values</span> <span class="o">=</span> <span class="n">hnc</span><span class="o">.</span><span class="n">tr_el</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">ntracers</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">ds_v</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">v_values</span><span class="p">,</span>  <span class="c1"># coords=[time,n_face,n_vert],</span>
                            <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;nSCHISM_hgrid_face&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;nSCHISM_vgrid_layers&#39;</span><span class="p">],</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">v</span><span class="o">+</span><span class="s1">&#39;_el&#39;</span><span class="p">)</span>
        <span class="n">ds_v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;mesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SCHISM_hgrid&quot;</span>
        <span class="n">ds_v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_horizontal_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;elem&quot;</span>
        <span class="n">ds_v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_vertical_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;half&quot;</span>
        <span class="n">ds_v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;i23d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># 3d half level on element</span>
        <span class="n">ds_v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ivs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hgrid_nc</span><span class="o">.</span><span class="n">zcor</span><span class="o">.</span><span class="n">ivs</span>
        <span class="n">hnc</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">hnc</span><span class="p">,</span> <span class="n">ds_v</span><span class="p">])</span>
    <span class="n">hnc</span> <span class="o">=</span> <span class="n">hnc</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;tr_el&#39;</span><span class="p">,</span> <span class="s1">&#39;tracer_list&#39;</span><span class="p">,</span> <span class="s1">&#39;tr_nd&#39;</span><span class="p">,</span> <span class="s1">&#39;tr_nd0&#39;</span><span class="p">])</span>

    <span class="n">hvar_t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hnc</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>  <span class="c1"># entire list</span>
    <span class="n">hvar</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hvar_t</span> <span class="k">if</span> <span class="s1">&#39;nSCHISM_hgrid&#39;</span> <span class="ow">in</span> <span class="n">hnc</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

<span class="c1">#   i23d: indicates location where outputs are defined. 1:3 - node 2D/3D whole/3D half level</span>
<span class="c1">#   4:6 - elem 2D/3D whole/half levels; 7:9 - side 2D/3D whole/half levels</span>
<span class="c1">#   the i23d value has to be accurate for VisIt to plot.</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hvar</span><span class="p">:</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hnc</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dl</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># 1D or 2D array, just expand.</span>
            <span class="n">dl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hnc</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
            <span class="n">vn</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="o">=</span> <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;mesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SCHISM_hgrid&quot;</span>
            <span class="n">dhc</span> <span class="o">=</span> <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dhc</span> <span class="o">==</span> <span class="s1">&#39;face&#39;</span><span class="p">:</span>
                <span class="n">dhc</span> <span class="o">=</span> <span class="s1">&#39;elem&#39;</span>
            <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_horizontal_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dhc</span>

            <span class="k">if</span> <span class="n">dl</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># 2D are all on full levels.</span>
                <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_vertical_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span>
                <span class="k">if</span> <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_horizontal_center&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;node&#39;</span><span class="p">:</span>
                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;i23d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_horizontal_center&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;elem&#39;</span><span class="p">:</span>
                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;i23d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># on edge</span>
                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;i23d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># I don&#39;t think that all variables are on full, but it&#39;s unclear how I can make this distinction.</span>
                <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_vertical_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;half&quot;</span>
                <span class="k">if</span> <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_horizontal_center&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;node&#39;</span><span class="p">:</span>
                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;i23d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="k">elif</span> <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_horizontal_center&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;elem&#39;</span><span class="p">:</span>
                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;i23d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># on edge</span>
                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;i23d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
            <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ivs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hgrid_nc</span><span class="o">.</span><span class="n">zcor</span><span class="o">.</span><span class="n">ivs</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># more than 1D, the variable needs to be broken down into a few variables with the name extention &quot;_i&quot;</span>
            <span class="n">c3</span> <span class="o">=</span> <span class="n">hnc</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># output the name for the last coordinates.</span>
            <span class="k">if</span> <span class="n">c3</span> <span class="o">==</span> <span class="s1">&#39;MBEDP&#39;</span><span class="p">:</span>
                <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_vertical_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span>
                <span class="n">sl</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;porosity&#39;</span><span class="p">]</span>  <span class="c1"># sediment property list</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sl</span><span class="p">):</span>
                    <span class="n">vn</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="o">=</span> <span class="n">hnc</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">MBEDP</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;mesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SCHISM_hgrid&quot;</span>
                    <span class="n">dhc</span> <span class="o">=</span> <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">dhc</span> <span class="o">==</span> <span class="s1">&#39;face&#39;</span><span class="p">:</span>
                        <span class="n">dhc</span> <span class="o">=</span> <span class="s1">&#39;elem&#39;</span>
                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_horizontal_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dhc</span>
                    <span class="c1"># so far, everything should be on full</span>
                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_vertical_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span>
                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;i23d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ivs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hgrid_nc</span><span class="o">.</span><span class="n">zcor</span><span class="o">.</span><span class="n">ivs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_vertical_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span>
                <span class="n">dl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hnc</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">hnc</span><span class="p">[</span><span class="n">c3</span><span class="p">]:</span>
                    <span class="n">vn</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="o">=</span> <span class="n">hnc</span><span class="p">[</span><span class="n">v</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;mesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SCHISM_hgrid&quot;</span>
                    <span class="n">dhc</span> <span class="o">=</span> <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">dhc</span> <span class="o">==</span> <span class="s1">&#39;face&#39;</span><span class="p">:</span>
                        <span class="n">dhc</span> <span class="o">=</span> <span class="s1">&#39;elem&#39;</span>
                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_horizontal_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dhc</span>
                    <span class="c1"># so far, everything should be on full</span>
                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_vertical_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span>
                    <span class="k">if</span> <span class="n">dl</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># each variable is then 1D</span>
                        <span class="k">if</span> <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_horizontal_center&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;node&#39;</span><span class="p">:</span>
                            <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;i23d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_horizontal_center&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;elem&#39;</span><span class="p">:</span>
                            <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;i23d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
                        <span class="k">elif</span> <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_horizontal_center&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">:</span>  <span class="c1"># on edge</span>
                            <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;i23d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                                <span class="s2">&quot;The data_horizontal_center option for </span><span class="si">%s</span><span class="s2"> is unavailable&quot;</span> <span class="o">%</span> <span class="n">v</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># I don&#39;t think that all variables are on full, but it&#39;s unclear how I can make this distinction.</span>
                        <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_vertical_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;half&quot;</span>
                        <span class="k">if</span> <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_horizontal_center&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;node&#39;</span><span class="p">:</span>
                            <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;i23d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
                        <span class="k">elif</span> <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_horizontal_center&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;elem&#39;</span><span class="p">:</span>
                            <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;i23d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
                        <span class="k">elif</span> <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_horizontal_center&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">:</span>  <span class="c1"># on edge</span>
                            <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;i23d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                                <span class="s2">&quot;The data_horizontal_center option for </span><span class="si">%s</span><span class="s2"> is unavailable&quot;</span> <span class="o">%</span> <span class="n">v</span><span class="p">)</span>

                    <span class="n">hnc</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ivs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hgrid_nc</span><span class="o">.</span><span class="n">zcor</span><span class="o">.</span><span class="n">ivs</span>
    <span class="c1"># hnc = hnc.drop([&#39;SED3D_bed&#39;, &#39;SED3D_bedfrac&#39;])</span>
    <span class="n">output_nc</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">hgrid_nc</span><span class="p">,</span> <span class="n">hnc</span><span class="p">])</span>

    <span class="c1"># additional variable attributes needed for VisIt to work: give them some dummy values</span>
    <span class="n">hc</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sigma_h_c&#39;</span><span class="p">)</span>
    <span class="n">hc</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ocean_s_coordinate h_c constant&#39;</span>
    <span class="n">hc</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;meters&#39;</span>
    <span class="n">hc</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;positive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span>

    <span class="n">tb</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sigma_theta_b&#39;</span><span class="p">)</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ocean_s_coordinate theta_b constant&#39;</span>
    <span class="n">tf</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sigma_theta_f&#39;</span><span class="p">)</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ocean_s_coordinate theta_f constant&#39;</span>

    <span class="n">mdepth</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sigma_maxdepth&#39;</span><span class="p">)</span>
    <span class="n">mdepth</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ocean_s_coordinate maximum depth cutoff (mixed s over z bound...&#39;</span>
    <span class="n">mdepth</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;meters&#39;</span>
    <span class="n">mdepth</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;positive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span>

    <span class="n">cs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">output_nc</span><span class="o">.</span><span class="n">nSCHISM_vgrid_layers</span><span class="p">),</span>
                      <span class="c1"># has to be float here.</span>
                      <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output_nc</span><span class="o">.</span><span class="n">nSCHISM_vgrid_layers</span><span class="p">)],</span>
                      <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Cs&#39;</span><span class="p">)</span>
    <span class="n">cs</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Function C(s) at whole levels&#39;</span>
    <span class="n">cs</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;postive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
    <span class="c1"># the attributes of sigma is very important to make VisIt work for some reason.</span>
    <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;S coordinates at whole levels&#39;</span>
    <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
    <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;standard_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ocean_s_coordinate&#39;</span>
    <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;positive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
    <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;h_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;h_c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;theta_b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;theta_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;formula_terms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;s: sigma eta: elev depth: depth a: sigma_theta_f b: sigma...&#39;</span>
    <span class="n">csf</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;coordinate_system_flag&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dry_value_flag&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0: use last-wet value; 1: use junk&#39;</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">([</span><span class="mf">0.01</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;minimum_depth&#39;</span><span class="p">)</span>

    <span class="c1"># the following definition of hgrid is not essential for VisIt, but just good to have for information.</span>
    <span class="n">hgrid</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">([</span><span class="o">-</span><span class="mi">2147483647</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SCHISM_hgrid&#39;</span><span class="p">)</span>
    <span class="n">hgrid</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Topology data of 2d unstructured mesh&#39;</span>
    <span class="n">hgrid</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;topology_dimension&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">hgrid</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;cf_role&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mesh_topology&#39;</span>
    <span class="n">hgrid</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;node_coordinates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SCHISM_hgrid_node_x&#39;</span> <span class="s1">&#39;SCHISM_hgrid_node_y&#39;</span>
    <span class="n">hgrid</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;face_node_connectivity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SCHISM_hgrid_face_nodes&#39;</span>
    <span class="n">hgrid</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;edge_coordinates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SCHISM_hgrid_edge_x&#39;</span> <span class="s1">&#39;SCHISM_hgrid_edge_y&#39;</span>
    <span class="n">hgrid</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;face_coordinates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SCHISM_hgrid_face_x&#39;</span> <span class="s1">&#39;SCHISM_hgrid_face_y&#39;</span>
    <span class="n">hgrid</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;edge_node_connectivity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SCHISM_hgrid_edge_nodes&#39;</span>

    <span class="n">output_nc</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="p">[</span><span class="n">hgrid</span><span class="p">,</span> <span class="n">output_nc</span><span class="p">,</span> <span class="n">hc</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="n">mdepth</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">csf</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">md</span><span class="p">])</span>

    <span class="c1"># remove a few unnecessary variables that make the VisIt crush.</span>
<span class="c1">#    output_nc = output_nc.drop([&#39;hgrid_contour_x&#39;,&#39;hgrid_contour_y&#39;])</span>
<span class="c1">#    output_nc = output_nc.drop([&#39;SED_1&#39;,&#39;SED_2&#39;,&#39;SED_0&#39;,&#39;SED3D_bed_thickness&#39;,</span>
<span class="c1">#                                &#39;SED3D_bed_age&#39;,&#39;SED3D_bed_porosity&#39;,&#39;SED3D_bedfrac_1&#39;,</span>
<span class="c1">#                                &#39;SED3D_bedfrac_2&#39;,&#39;SED3D_bedfrac_3&#39;,</span>
<span class="c1">#                                &#39;SED3D_dp&#39;,&#39;SED3D_rough&#39;])</span>

    <span class="c1"># maybe it doesn&#39;t like variables on edge?</span>
    <span class="n">output_nc</span> <span class="o">=</span> <span class="n">output_nc</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;q2&#39;</span><span class="p">,</span> <span class="s1">&#39;xl&#39;</span><span class="p">,</span> <span class="s1">&#39;su2&#39;</span><span class="p">,</span> <span class="s1">&#39;sv2&#39;</span><span class="p">])</span>

    <span class="n">output_nc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Time&#39;</span>
    <span class="c1">#output_nc[&#39;time&#39;].encoding[&#39;units&#39;] = &#39;days since %s&#39;%init_date</span>
    <span class="n">output_nc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;base_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_date</span>
    <span class="n">output_nc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;standard_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>

    <span class="c1"># add global attributes</span>
    <span class="n">output_nc</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Conventions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CF-1.0, UGRID-1.0&quot;</span>
    <span class="n">output_nc</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SCHISM Model output&quot;</span>
    <span class="n">output_nc</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;institution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SCHISM Model output&quot;</span>
    <span class="n">output_nc</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SCHISM model output version v10&quot;</span>
    <span class="n">output_nc</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;references&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://ccrm.vims.edu/schismweb/&quot;</span>
    <span class="n">output_nc</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;converted from hotstart.nc&quot;</span>
    <span class="n">output_nc</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SCHISM Model output&quot;</span>
    <span class="n">output_nc</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SCHISM Model output&quot;</span>
    <span class="n">output_nc</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;VisIT_plugin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;https://schism.water.ca.gov/library/-/document_library/view/3476283&quot;</span>
    <span class="n">output_nc</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;_CoordSysBuilder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ucar.nc2.dataset.conv.CF1Convention&quot;</span>

    <span class="n">output_nc</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4_CLASSIC&#39;</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">hotstart</span><span class="p">(</span><span class="s1">&#39;hotstart.yaml&#39;</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;TEM&#39;</span><span class="p">,</span> <span class="s1">&#39;SAL&#39;</span><span class="p">,</span> <span class="s1">&#39;SED&#39;</span><span class="p">])</span>
    <span class="c1">#h = hotstart(&#39;hotstart_test.yaml&#39;)</span>
    <span class="n">h</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">()</span>
    <span class="n">h</span><span class="o">.</span><span class="n">create_hotstart</span><span class="p">()</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">nc_dataset</span>

    <span class="c1"># %% making plot</span>
    <span class="n">coll</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">plot_elems</span><span class="p">(</span><span class="n">v1</span><span class="p">[</span><span class="s1">&#39;tr_el&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">22</span><span class="p">))</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">coll</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Regional Temperature&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">home</a>|&nbsp;</li>
        <li><a href="../../search.html">search</a>|&nbsp;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">schimpy.schism_hotstart</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, California Department of Water Resources.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>